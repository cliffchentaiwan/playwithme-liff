<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å¤¥ä¼´å¾Œå° (v2.0)</title> <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <title>é™ªç©å¤¥ä¼´å¾Œå° (v2.2)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; color: #333; }
.card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Header å„ªåŒ–ï¼šåŠ å…¥è©•åˆ†é¡¯ç¤º */
.header { display: flex; align-items: center; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid #eee; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-info { flex: 1; }
        .rating-display { font-size: 14px; color: #f57c00; font-weight: bold; margin-top: 4px; display: flex; align-items: center; }
        .rating-star { margin-right: 4px; font-size: 16px; }

.badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
.badge-gray { background: #eee; color: #666; }
.badge-green { background: #e8f5e9; color: #06c755; }
        .badge-orange { background: #fff3e0; color: #ef6c00; }
        
label { display: block; font-weight: bold; margin: 15px 0 5px; font-size: 14px; color: #555; }
input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 15px; }
        select:disabled { background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2; font-weight: bold; opacity: 1; }

.checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
.check-status { display: flex; align-items: center; }
.check-icon { margin-right: 10px; font-size: 18px; color: #ddd; width: 24px; text-align: center;}
.check-icon.done { color: #06c755; }
        .btn-upload { background: #06c755; color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-upload { background: #06c755; color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.2s; }
        .btn-upload:disabled { background: #ccc; cursor: not-allowed; }

#file-input { display: none; }
.time-slot { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
.btn-del { color: #d32f2f; font-weight: bold; cursor: pointer; padding: 5px; }
        
.tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; padding-bottom: 20px; z-index: 999; }
.tab-item { flex: 1; text-align: center; padding: 10px; color: #999; cursor: pointer; font-size: 12px; }
.tab-item.active-tab { color: #06c755; font-weight: bold; border-top: 2px solid #06c755; }
.tab-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .order-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
        .order-card.pending { border-left-color: #ff9800; } 
        .order-card.accepted { border-left-color: #06c755; }
        .order-header { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-accept { flex: 1; background: #06c755; color: white; border: none; padding: 8px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-reject { flex: 1; background: #ff5252; color: white; border: none; padding: 8px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-main { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }

        .btn-main { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: background 0.3s; }
        .btn-main:disabled { background-color: #999; cursor: not-allowed; }

        /* éª¨æ¶å±è¼‰å…¥å‹•ç•« */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; color: transparent !important; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

.page { display: none; }
.active { display: block; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #loading.hidden { display: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        #loading.hidden { opacity: 0; pointer-events: none; }
</style>
</head>
<body>

<div id="loading">
        <p>ğŸ”„ ç³»çµ±è®€å–ä¸­ v2.0...</p>
        <p>ğŸš€ ç³»çµ±è¼‰å…¥ä¸­ v2.2...</p>
</div>

<div id="tab-profile" class="page active">
        <h2 style="margin-left: 5px;">å€‹äººæª”æ¡ˆ v2.0</h2> <div class="card">
        <div class="card">
<div class="header">
                <img id="form-avatar" class="avatar" src="">
                <div style="flex:1">
                    <h3 id="form-name" style="margin:0 0 5px 0;"></h3>
                    <span id="form-status" class="badge badge-gray">æœªé©—è­‰</span>
                <img id="form-avatar" class="avatar skeleton" src="">
                <div class="header-info">
                    <h3 id="form-name" class="skeleton" style="margin:0 0 5px 0; display:inline-block; min-width: 100px;">è¼‰å…¥ä¸­</h3>
                    <div style="margin-bottom: 5px;">
                        <span id="form-status" class="badge badge-gray">è®€å–ç‹€æ…‹...</span>
                    </div>
                    <div id="rating-area" class="rating-display" style="display:none;">
                        <span class="rating-star">â­</span>
                        <span id="rating-score">0.0</span>
                        <span style="color:#999; font-weight:normal; margin-left:5px;">(ç¶œåˆè©•åˆ†)</span>
                    </div>
</div>
</div>
<div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-top:10px;">
@@ -61,6 +82,7 @@ <h3 id="form-name" style="margin:0 0 5px 0;"></h3>
<option value="Offline">ğŸ”´ ä¼‘æ¯ä¸­ (éš±è—)</option>
<option value="Online">ğŸŸ¢ é–‹æ”¾æ¥å–® (ä¸Šç·š)</option>
</select>
                <p id="status-hint" style="font-size:12px; color:#ff9800; margin-top:5px; display:none;">âš ï¸ è³‡æ–™å¯©æ ¸ä¸­ï¼Œé€šéå¾Œæ‰èƒ½é–‹å•Ÿæ¥å–®ã€‚</p>
</div>
</div>

@@ -107,59 +129,126 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>

<script>
const LIFF_ID = "2008808827-DzeTt84n"; 
        // ğŸ‘‡ è«‹ç¢ºèªé€™å€‹ç¶²å€æ˜¯æ‚¨ã€Œæœ€æ–°éƒ¨ç½²ã€çš„ Apps Script ç¶²å€
        // ğŸ‘‡ é€™è£¡é‚„æ˜¯å¡«å…¥æ‚¨æœ€æ–°çš„ Apps Script ç¶²å€
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec"; 

let userProfile = null;
let mySchedule = [];
let currentUploadType = "";

async function main() {
            // åˆå§‹åŒ–æ™‚æ®µ
const timeSelect = document.getElementById("sel-time");
for (let i = 8; i <= 21; i++) { 
let h = i < 10 ? "0" + i : i;
                timeSelect.innerHTML += `<option value="${h}:00">${h}:00</option>`;
                timeSelect.innerHTML += `<option value="${h}:30">${h}:30</option>`;
                timeSelect.innerHTML += `<option value="${h}:00">${h}:00</option><option value="${h}:30">${h}:30</option>`;
}
            

try {
await liff.init({ liffId: LIFF_ID });
if (!liff.isLoggedIn()) { liff.login(); return; }
userProfile = await liff.getProfile();
                if(!userProfile) throw new Error("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™");

                // ğŸš€ UXå„ªåŒ–ï¼šå…ˆè®€å–å¿«å– (Local Storage)ï¼Œè®“ç•«é¢çœ‹èµ·ä¾†æ˜¯ã€Œç§’é–‹ã€
                loadFromCache();
                
                // ç„¶å¾ŒèƒŒæ™¯å»æŠ“æ–°è³‡æ–™
checkLogin();
} catch (err) {
                alert("ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤: " + err);
                alert("ç³»çµ±éŒ¯èª¤: " + err);
document.getElementById("loading").classList.add("hidden");
}
}

        // âœ¨ æ–°åŠŸèƒ½ï¼šå¾æ‰‹æ©Ÿæš«å­˜è®€å–è³‡æ–™
        function loadFromCache() {
            const cachedData = localStorage.getItem("worker_data_" + userProfile.userId);
            if (cachedData) {
                console.log("è®€å–å¿«å–è³‡æ–™...");
                const d = JSON.parse(cachedData);
                renderUI(d);
                document.getElementById("loading").classList.add("hidden"); // æœ‰å¿«å–å°±å…ˆé—œé–‰ Loading
            }
        }

async function checkLogin() {
try {
const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "login", userId: userProfile.userId }) });
                const text = await res.text();
                if (text.trim().startsWith("<")) { alert("å¾Œç«¯é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²"); document.getElementById("loading").classList.add("hidden"); return; }
                const result = await res.json();

                const result = JSON.parse(text);
document.getElementById("loading").classList.add("hidden");
                document.getElementById("form-avatar").src = userProfile.pictureUrl;
                document.getElementById("form-name").innerText = userProfile.displayName;

if (result.isRegistered) {
const d = result.data;
                    document.getElementById("inp-rate").value = d.rate;
                    document.getElementById("inp-tags").value = d.tags;
                    document.getElementById("inp-intro").value = d.intro;
                    document.getElementById("inp-bank").value = d.bank;
                    document.getElementById("inp-online-status").value = d.status;
                    if(d.verified==="Verified") { document.getElementById("form-status").innerText="å·²èªè­‰"; document.getElementById("form-status").className="badge badge-green"; }
                    if(d.docFront) document.getElementById("icon-front").className="check-icon done";
                    if(d.docBack) document.getElementById("icon-back").className="check-icon done";
                    if(d.docPolice) document.getElementById("icon-police").className="check-icon done";
                    try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule=[]; }
                    renderSchedule();
                    // æ›´æ–°å¿«å–
                    localStorage.setItem("worker_data_" + userProfile.userId, JSON.stringify(d));
                    renderUI(d);
                } else {
                    // ç¬¬ä¸€æ¬¡ä¾†çš„ï¼Œé¡¯ç¤ºåŸºæœ¬é ­åƒ
                    document.getElementById("form-avatar").src = userProfile.pictureUrl;
                    document.getElementById("form-name").innerText = userProfile.displayName;
                    document.getElementById("form-avatar").classList.remove("skeleton");
                    document.getElementById("form-name").classList.remove("skeleton");
                }
            } catch (err) { 
                console.error(err);
                // å¦‚æœæ²’å¿«å–åˆé€£ç·šå¤±æ•—ï¼Œæ‰å ±éŒ¯
                if(!localStorage.getItem("worker_data_" + userProfile.userId)) {
                    document.getElementById("loading").classList.add("hidden");
                    alert("é€£ç·šä¸ç©©ï¼Œè«‹é‡æ–°æ•´ç†");
                }
            }
        }

        // âœ¨ æŠŠç•«é¢æ¸²æŸ“é‚è¼¯ç¨ç«‹å‡ºä¾†
        function renderUI(d) {
            document.getElementById("form-avatar").src = userProfile.pictureUrl; // é€™è£¡é‚„æ˜¯ç”¨ LINE çš„æœ€æ–°é ­åƒ
            document.getElementById("form-avatar").classList.remove("skeleton");
            
            document.getElementById("form-name").innerText = userProfile.displayName;
            document.getElementById("form-name").classList.remove("skeleton");

            document.getElementById("inp-rate").value = d.rate;
            document.getElementById("inp-tags").value = d.tags;
            document.getElementById("inp-intro").value = d.intro;
            document.getElementById("inp-bank").value = d.bank;
            
            // è™•ç†è©•åˆ† (å¾ tags è£¡é¢è§£æ â­åˆ†æ•¸)
            if (d.tags && d.tags.includes("â­")) {
                const match = d.tags.match(/â­(\d+\.\d+)/);
                if (match) {
                    document.getElementById("rating-score").innerText = match[1];
                    document.getElementById("rating-area").style.display = "flex";
}
            } catch (err) { document.getElementById("loading").classList.add("hidden"); alert("é€£ç·šéŒ¯èª¤ï¼š" + err); }
            } else {
                // å¦‚æœå®Œå…¨æ²’æœ‰è©•åˆ†ï¼Œé¡¯ç¤º 0.0 æˆ–éš±è—ï¼Œé€™é‚Šé¸æ“‡é¡¯ç¤º
                document.getElementById("rating-area").style.display = "flex";
            }

            // è™•ç†ç‹€æ…‹é–å®š
            const statusSelect = document.getElementById("inp-online-status");
            const statusHint = document.getElementById("status-hint");
            const statusBadge = document.getElementById("form-status");

            if (d.verified === "Verified") {
                statusSelect.disabled = false;
                statusSelect.value = d.status;
                statusHint.style.display = "none";
                statusBadge.innerText = "å·²èªè­‰";
                statusBadge.className = "badge badge-green";
            } else {
                statusSelect.innerHTML = "<option>ğŸŸ¡ è³‡æ–™å¯©æ ¸ä¸­</option>";
                statusSelect.disabled = true;
                statusHint.style.display = "block";
                statusBadge.innerText = "å¯©æ ¸ä¸­";
                statusBadge.className = "badge badge-orange";
            }

            if(d.docFront) document.getElementById("icon-front").className="check-icon done";
            if(d.docBack) document.getElementById("icon-back").className="check-icon done";
            if(d.docPolice) document.getElementById("icon-police").className="check-icon done";
            try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule=[]; }
            renderSchedule();
}

function switchTab(tab) {
@@ -175,6 +264,7 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>
}
}

        // é€™è£¡å¯ä»¥çœç•¥ loadOrders çš„å„ªåŒ–ï¼Œå…ˆå°ˆæ³¨åœ¨ Profile
async function loadOrders() {
const container = document.getElementById("order-list");
container.innerHTML = '<p style="text-align:center; color:#999;">é‡æ–°æ•´ç†ä¸­...</p>';
@@ -188,7 +278,7 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>
}
result.orders.forEach(order => {
let statusBadge = `<span style="color:orange">å¾…ç¢ºèª</span>`;
                    let buttons = `<button class="btn-reject" onclick="updateOrder(${order.row}, 'å·²æ‹’çµ•')">æ‹’çµ•</button><button class="btn-accept" onclick="updateOrder(${order.row}, 'å·²æ¥å–®')">æ¥å–®</button>`;
                    let buttons = `<button class="btn-reject" onclick="updateOrder(${order.row}, 'å·²æ‹’çµ•', this)">æ‹’çµ•</button><button class="btn-accept" onclick="updateOrder(${order.row}, 'å·²æ¥å–®', this)">æ¥å–®</button>`;
if (order.status === 'å·²æ¥å–®') { statusBadge = `<span style="color:green">âœ… å·²æ¥å–®</span>`; buttons = `<button style="width:100%;background:#eee;border:none;padding:8px;border-radius:5px;" disabled>ç­‰å¾…æœå‹™é–‹å§‹</button>`; }
else if (order.status === 'å·²æ‹’çµ•') { statusBadge = `<span style="color:red">âŒ å·²æ‹’çµ•</span>`; buttons = ``; }
else if (order.status === 'å·²å®Œæˆ') { statusBadge = `<span style="color:gray">ğŸ å·²å®Œæˆ</span>`; buttons = `<div style="font-size:12px;color:#f57c00;">â˜… ${order.rating||""} ${order.comment||""}</div>`; }
@@ -207,8 +297,16 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>
} catch (err) { container.innerHTML = "è¼‰å…¥å¤±æ•—"; }
}

        async function updateOrder(row, status) {
        // ğŸš€ UXå„ªåŒ–ï¼šæŒ‰éˆ•é»æ“Šå¾Œè®Šè‰² disabled
        async function updateOrder(row, status, btnElement) {
if(!confirm(`ç¢ºå®šè¦è®Šæ›´ç‚ºã€Œ${status}ã€å—ï¼Ÿ`)) return;
            
            const originalText = btnElement.innerText;
            btnElement.innerText = "è™•ç†ä¸­...";
            btnElement.disabled = true;
            // æŠŠæ—é‚Šçš„æŒ‰éˆ•ä¹Ÿé–ä½ï¼Œé¿å…é€£æŒ‰
            btnElement.parentElement.querySelectorAll("button").forEach(b => b.disabled = true);

await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "updateOrderStatus", row: row, newStatus: status }) });
alert("æ›´æ–°æˆåŠŸ"); loadOrders();
}
@@ -222,27 +320,47 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>
const c = document.getElementById("schedule-list"); c.innerHTML = "";
mySchedule.forEach((s, i) => c.innerHTML += `<div class="time-slot"><span>ğŸ•’ ${s}</span><span class="btn-del" onclick="removeSlot(${i})">âœ•</span></div>`);
}

        // ğŸš€ UXå„ªåŒ–ï¼šå„²å­˜æŒ‰éˆ•ç‹€æ…‹å›é¥‹
async function saveProfile() {
if(!userProfile) return;
            const btn = document.querySelector(".btn-main"); btn.innerText="å„²å­˜ä¸­..."; btn.disabled=true;
            const btn = document.querySelector(".btn-main"); 
            const originalText = btn.innerText;
            btn.innerText = "â³ å„²å­˜ä¸­..."; 
            btn.disabled = true;
            btn.style.background = "#999";

const data = { action: "updateProfile", userId: userProfile.userId, name: userProfile.displayName, photo: userProfile.pictureUrl, rate: document.getElementById("inp-rate").value, tags: document.getElementById("inp-tags").value, intro: document.getElementById("inp-intro").value, bank: document.getElementById("inp-bank").value, status: document.getElementById("inp-online-status").value, schedule: JSON.stringify(mySchedule) };
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
            alert("âœ… è³‡æ–™æ›´æ–°æˆåŠŸ"); btn.innerText="å„²å­˜æ›´æ–°"; btn.disabled=false;
            
            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
                // æ›´æ–°æˆåŠŸå¾Œï¼Œä¹Ÿè¦æ›´æ–°æœ¬åœ°å¿«å–
                const currentCache = JSON.parse(localStorage.getItem("worker_data_" + userProfile.userId) || "{}");
                const newData = { ...currentCache, ...data, verified: currentCache.verified || "Pending" }; // åˆä½µè³‡æ–™
                localStorage.setItem("worker_data_" + userProfile.userId, JSON.stringify(newData));

                alert("âœ… è³‡æ–™æ›´æ–°æˆåŠŸ"); 
            } catch(e) {
                alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            } finally {
                btn.innerText = originalText; 
                btn.disabled = false;
                btn.style.background = "#06c755";
            }
}

function triggerUpload(type) { 
currentUploadType = type; 
document.getElementById("file-input").click(); 
}

        // ğŸ”¥ é‡é»ï¼šé€™æ®µä»£ç¢¼æœƒå‘Šè¨´æ‚¨ã€ŒçœŸå¯¦çš„éŒ¯èª¤åŸå› ã€
        // ğŸš€ UXå„ªåŒ–ï¼šä¸Šå‚³æŒ‰éˆ•ç‹€æ…‹å›é¥‹
function handleFileSelect() {
const file = document.getElementById("file-input").files[0];
if (!file) return;

            // é™åˆ¶æª”æ¡ˆå¤§å° (5MB)
if (file.size > 5 * 1024 * 1024) {
                alert("âŒ æª”æ¡ˆå¤ªå¤§ï¼è«‹ä½¿ç”¨å°æ–¼ 5MB çš„ç…§ç‰‡ (æˆ–ç”¨ LINE å‚³çµ¦è‡ªå·±å£“ç¸®ä¸€ä¸‹)");
                alert("âŒ æª”æ¡ˆå¤ªå¤§ï¼è«‹ä½¿ç”¨å°æ–¼ 5MB çš„ç…§ç‰‡");
return;
}

@@ -277,8 +395,7 @@ <h2 style="margin-left: 5px;">è¨‚å–®ç®¡ç†</h2>
if(currentUploadType==='police') document.getElementById("icon-police").className="check-icon done";
btn.innerText = "å·²ä¸Šå‚³";
} else {
                        // ğŸ”¥ é€™è£¡æœƒé¡¯ç¤ºï¼šFolder ID éŒ¯èª¤ / æ¬Šé™ä¸è¶³ / ...
                        alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + (result.error || "æœªçŸ¥åŸå› ï¼Œè«‹æˆªåœ–çµ¦å·¥ç¨‹å¸«"));
                        alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + (result.error || "æœªçŸ¥åŸå› "));
btn.innerText = originalText;
btn.disabled = false;
}
