<script>
    const LIFF_ID = "2008808827-DzeTt84n"; 
    const SCRIPT_URL = "在此更換為你的_GAS_URL"; 

    let userProfile = null;
    let mySchedule = [];
    const dayOrder = { "週一":1, "週二":2, "週三":3, "週四":4, "週五":5, "週六":6, "週日":7 };

    async function main() {
        initTimeSelects();
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            
            // 【縫合重點 1】強制背景註冊，解決照片消失問題
            syncPhotoToDatabase();

            loadFromCache();
            checkLogin();
        } catch (err) {
            console.error(err);
            document.getElementById("loading").classList.add("hidden");
        }
    }

    async function syncPhotoToDatabase() {
        // 夥伴一進來，不管有沒有點存檔，先讓家長端能看到他的最新頭像
        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "register",
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                pictureUrl: userProfile.pictureUrl
            })
        });
    }

    async function checkLogin() {
        try {
            const res = await fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "login", userId: userProfile.userId }) 
            });
            const result = await res.json();
            document.getElementById("loading").classList.add("hidden");
            if (result.isRegistered) {
                renderUI(result.data);
                localStorage.setItem("worker_data_" + userProfile.userId, JSON.stringify(result.data));
            } else {
                // 初次登入顯示
                document.getElementById("form-avatar").src = userProfile.pictureUrl;
                document.getElementById("form-name").innerText = userProfile.displayName;
                document.getElementById("form-avatar").classList.remove("skeleton");
                document.getElementById("form-name").classList.remove("skeleton");
            }
        } catch (err) { document.getElementById("loading").classList.add("hidden"); }
    }

    // (保留你原有的 renderUI, addBatchSlots, removeSlot, sortSchedule, renderSchedule 函式)

    async function saveProfile() {
        if(!userProfile) return;
        const btn = document.querySelector(".btn-main");
        const originalText = btn.innerText;
        btn.innerText = "⏳ 儲存中..."; btn.disabled = true;

        const data = { 
            action: "updateProfile", 
            userId: userProfile.userId, 
            name: userProfile.displayName, 
            photo: userProfile.pictureUrl, // 確保照片連結被寫入
            rate: document.getElementById("inp-rate").value, 
            tags: document.getElementById("inp-tags").value, 
            intro: document.getElementById("inp-intro").value, 
            bank: document.getElementById("inp-bank").value, 
            status: document.getElementById("inp-online-status").value, 
            schedule: JSON.stringify(mySchedule) 
        };
        
        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
            alert("✅ 資料更新成功"); 
        } catch(e) { alert("更新失敗"); } 
        finally { btn.innerText = originalText; btn.disabled = false; }
    }

    // (保留你原有的 switchTab, loadOrders, updateOrder 函式)

    main();
</script>
