<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å¤¥ä¼´å¾Œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; display: block; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin: 0 0 5px 0; font-size: 20px; }
        .status-badge { text-align: center; margin-bottom: 20px; display: block; }
        .badge { background: #e8f5e9; color: #06c755; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold; }
        label { display: block; font-weight: bold; margin: 15px 0 5px; font-size: 14px; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 15px; }
        .time-slot { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
        .btn-del { color: #d32f2f; font-weight: bold; cursor: pointer; padding: 5px; }
        .btn-main { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size:40px;">ğŸš€</div>
    <div style="margin-top:10px;">è³‡æ–™è®€å–ä¸­...</div>
</div>

<div class="card">
    <img id="form-avatar" class="avatar" src="https://via.placeholder.com/80">
    <h2 id="form-name">è¼‰å…¥ä¸­...</h2>
    <div class="status-badge"><span id="form-status" class="badge">æª¢æŸ¥ä¸­...</span></div>
</div>

<div class="card">
    <h3>ğŸ“ åŸºæœ¬è³‡æ–™</h3>
    <label>æ™‚è–ª (TWD)</label>
    <input type="number" id="inp-rate" placeholder="ä¾‹å¦‚: 300">
    <label>æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
    <input type="text" id="inp-tags" placeholder="ç•«ç•«, é‹¼ç´, é‹å‹•">
    <label>è‡ªæˆ‘ä»‹ç´¹</label>
    <textarea id="inp-intro" rows="3"></textarea>
    <label>éŠ€è¡Œå¸³è™Ÿ</label>
    <input type="text" id="inp-bank">
</div>

<div class="card">
    <h3>ğŸ“… æ’ç­è¨­å®š</h3>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="sel-day" style="flex:1"><option value="é€±ä¸€">é€±ä¸€</option><option value="é€±äºŒ">é€±äºŒ</option><option value="é€±ä¸‰">é€±ä¸‰</option><option value="é€±å››">é€±å››</option><option value="é€±äº”">é€±äº”</option><option value="é€±å…­">é€±å…­</option><option value="é€±æ—¥">é€±æ—¥</option></select>
        <select id="sel-time" style="flex:1"><option value="09:00">09:00</option><option value="10:00">10:00</option><option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option>19:00</option></select>
        <button onclick="addSlot()" style="background:#1976d2; color:white; border:none; border-radius:8px; width:50px;">+</button>
    </div>
    <div id="schedule-list"></div>
</div>

<button class="btn-main" onclick="saveProfile()">å„²å­˜æ›´æ–°</button>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    const LIFF_ID = "2008808827-DzeTt84n"; 

    let userProfile = null;
    let mySchedule = [];

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            // è‡ªå‹•ç™»å…¥åˆ¤æ–·
            if (!liff.isLoggedIn()) { 
                liff.login(); 
                return; 
            }
            userProfile = await liff.getProfile();
            checkLogin();
        } catch(e) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + e);
            document.getElementById("loading").style.display = "none";
        }
    };

    async function checkLogin() {
        try {
            // [é—œéµä¿®æ­£] åŠ å…¥ headers: text/plain é¿å… iOS é˜»æ“‹
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: "login", userId: userProfile.userId })
            });
            
            const result = await res.json();
            document.getElementById("loading").style.display = "none";
            
            // é¡¯ç¤ºç•«é¢è³‡æ–™
            document.getElementById("form-avatar").src = userProfile.pictureUrl || "https://via.placeholder.com/80";
            document.getElementById("form-name").innerText = userProfile.displayName;

            if(result.isRegistered) {
                const d = result.data;
                document.getElementById("inp-rate").value = d.rate;
                document.getElementById("inp-tags").value = d.tags;
                document.getElementById("inp-intro").value = d.intro;
                document.getElementById("inp-bank").value = d.bank;
                document.getElementById("form-status").innerText = d.verified === "Verified" ? "âœ… å·²èªè­‰ä¸Šæ¶" : "â³ è³‡æ–™å¯©æ ¸ä¸­";
                try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule = []; }
                renderSchedule();
            } else {
                document.getElementById("form-status").innerText = "ğŸ‘‹ æ­¡è¿æ–°å¤¥ä¼´";
            }
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤ (è«‹é‡æ–°æ•´ç†): " + e);
            document.getElementById("loading").style.display = "none";
        }
    }

    function addSlot() {
        const slot = `${document.getElementById("sel-day").value} ${document.getElementById("sel-time").value}`;
        if(!mySchedule.includes(slot)) { mySchedule.push(slot); mySchedule.sort(); renderSchedule(); }
    }
    function removeSlot(idx) { mySchedule.splice(idx, 1); renderSchedule(); }
    function renderSchedule() {
        const div = document.getElementById("schedule-list");
        div.innerHTML = "";
        mySchedule.forEach((s, i) => {
            div.innerHTML += `<div class="time-slot"><span>${s}</span><span class="btn-del" onclick="removeSlot(${i})">&times;</span></div>`;
        });
    }

    async function saveProfile() {
        const btn = document.querySelector(".btn-main");
        btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;

        const data = {
            action: "updateProfile",
            userId: userProfile.userId,
            name: userProfile.displayName,
            photo: userProfile.pictureUrl,
            rate: document.getElementById("inp-rate").value,
            tags: document.getElementById("inp-tags").value,
            intro: document.getElementById("inp-intro").value,
            bank: document.getElementById("inp-bank").value,
            status: "Online",
            schedule: JSON.stringify(mySchedule)
        };

        try {
            // [é—œéµä¿®æ­£] é€™è£¡ä¹Ÿè¦åŠ  headers
            await fetch(SCRIPT_URL, { 
                method: "POST", 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data) 
            });
            alert("âœ… è³‡æ–™æ›´æ–°æˆåŠŸï¼");
        } catch(e) {
            alert("æ›´æ–°å¤±æ•—ï¼š" + e);
        } finally {
            btn.innerText = "å„²å­˜æ›´æ–°"; btn.disabled = false;
        }
    }
</script>
</body>
</html>
