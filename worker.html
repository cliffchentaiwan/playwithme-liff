<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å¤¥ä¼´å¾Œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; color: #333; }
        
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid #eee; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-gray { background: #eee; color: #666; }
        .badge-green { background: #e8f5e9; color: #06c755; }
        .badge-orange { background: #fff3e0; color: #ef6c00; }
        
        label { display: block; font-weight: bold; margin: 15px 0 5px; font-size: 14px; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 15px; }
        
        /* Checklist */
        .checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .check-status { display: flex; align-items: center; }
        .check-icon { margin-right: 10px; font-size: 18px; color: #ddd; width: 24px; text-align: center;}
        .check-icon.done { color: #06c755; }
        .doc-title { font-size: 15px; font-weight: 500; }
        
        .btn-upload { background: #06c755; color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-upload:disabled { background: #ccc; cursor: not-allowed; }
        .uploaded-link { color: #06c755; text-decoration: none; font-size: 13px; margin-right: 10px; }

        .time-slot { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
        .btn-del { color: #d32f2f; font-weight: bold; cursor: pointer; padding: 5px; }

        .btn-main { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); }

        .page { display: none; }
        .active { display: block; }
    </style>
</head>
<body>

    <div id="loading" class="page active" style="text-align:center; padding-top: 50px;">
        <p>ğŸ”„ æ­£åœ¨è®€å–æ‚¨çš„è³‡æ–™...</p>
    </div>

    <div id="main-page" class="page">
        <h2 id="page-title" style="margin-left: 5px;">å»ºç«‹æ‚¨çš„æª”æ¡ˆ</h2>
        
        <div class="card">
            <div class="header">
                <img id="form-avatar" class="avatar" src="">
                <div style="flex:1">
                    <h3 id="form-name" style="margin:0 0 5px 0;"></h3>
                    <span id="form-status" class="badge badge-gray">æœªé©—è­‰</span>
                </div>
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-top:10px;">
                <label style="margin-top:0">ç›®å‰ç‹€æ…‹</label>
                <select id="inp-online-status" style="background:white;">
                    <option value="Offline">ğŸ”´ ä¼‘æ¯ä¸­ (éš±è—)</option>
                    <option value="Online">ğŸŸ¢ é–‹æ”¾æ¥å–® (ä¸Šç·š)</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ›¡ï¸ ä¿¡ä»»é©—è­‰ (å¿…å¡«)</h3>
            <p style="font-size:13px; color:#888; margin-bottom:15px;">å®Œæˆé©—è­‰å¾Œï¼Œå®¶é•·å°æ‚¨çš„ä¿¡ä»»åº¦æœƒå¤§å¹…æå‡ã€‚</p>
            
            <div class="checklist-item">
                <div class="check-status">
                    <span class="check-icon done">âœ”</span>
                    <span class="doc-title">æ‰‹æ©Ÿè™Ÿç¢¼ç¶å®š (LINE)</span>
                </div>
            </div>

            <div class="checklist-item">
                <div class="check-status">
                    <span class="check-icon" id="icon-front">â—</span>
                    <span class="doc-title">èº«åˆ†è­‰ (æ­£é¢)</span>
                </div>
                <div>
                    <a id="link-front" href="#" target="_blank" class="uploaded-link" style="display:none">æŸ¥çœ‹</a>
                    <button class="btn-upload" onclick="triggerUpload('front')">ä¸Šå‚³</button>
                </div>
            </div>

            <div class="checklist-item">
                <div class="check-status">
                    <span class="check-icon" id="icon-back">â—</span>
                    <span class="doc-title">èº«åˆ†è­‰ (åé¢)</span>
                </div>
                <div>
                    <a id="link-back" href="#" target="_blank" class="uploaded-link" style="display:none">æŸ¥çœ‹</a>
                    <button class="btn-upload" onclick="triggerUpload('back')">ä¸Šå‚³</button>
                </div>
            </div>

            <div class="checklist-item">
                <div class="check-status">
                    <span class="check-icon" id="icon-police">â—</span>
                    <span class="doc-title">è‰¯æ°‘è­‰</span>
                </div>
                <div>
                    <a id="link-police" href="#" target="_blank" class="uploaded-link" style="display:none">æŸ¥çœ‹</a>
                    <button class="btn-upload" onclick="triggerUpload('police')">ä¸Šå‚³</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ å€‹äººè³‡æ–™</h3>
            <label>è¨­å®šæ™‚è–ª (NT$)</label>
            <input type="number" id="inp-rate" placeholder="ä¾‹å¦‚ï¼š350">

            <label>å°ˆé•·æ¨™ç±¤</label>
            <input type="text" id="inp-tags" placeholder="ä¾‹å¦‚ï¼š#ç¾è¡“ #é‹¼ç´ #ä¼´è®€">

            <label>è‡ªæˆ‘ä»‹ç´¹</label>
            <textarea id="inp-intro" rows="3" placeholder="è«‹ç°¡å–®ä»‹ç´¹æ‚¨çš„ç¶“é©—..."></textarea>
            
            <label>éŠ€è¡Œå¸³è™Ÿ (è–ªè³‡è½‰å¸³ç”¨)</label>
            <input type="text" id="inp-bank" placeholder="éŠ€è¡Œä»£ç¢¼ + å¸³è™Ÿ">
        </div>

        <div class="card">
            <h3>ğŸ“… å¯é ç´„æ™‚æ®µ</h3>
            <div id="schedule-list" style="margin-bottom:15px;">
                </div>
            
            <div style="display:flex; gap:10px;">
                <select id="sel-day" style="flex:1">
                    <option value="é€±ä¸€">é€±ä¸€</option>
                    <option value="é€±äºŒ">é€±äºŒ</option>
                    <option value="é€±ä¸‰">é€±ä¸‰</option>
                    <option value="é€±å››">é€±å››</option>
                    <option value="é€±äº”">é€±äº”</option>
                    <option value="é€±å…­">é€±å…­</option>
                    <option value="é€±æ—¥">é€±æ—¥</option>
                </select>
                <select id="sel-time" style="flex:1">
                    <option value="ä¸Šåˆ (09-12)">ä¸Šåˆ (09-12)</option>
                    <option value="ä¸‹åˆ (13-17)">ä¸‹åˆ (13-17)</option>
                    <option value="æ™šä¸Š (18-21)">æ™šä¸Š (18-21)</option>
                </select>
            </div>
            <button onclick="addSlot()" style="width:100%; margin-top:10px; background:#e3f2fd; color:#1565c0; border:none; padding:10px; border-radius:8px; font-weight:bold;">+ æ–°å¢æ™‚æ®µ</button>
        </div>

        <button class="btn-main" onclick="saveProfile()">å„²å­˜ä¸¦æ›´æ–°è³‡æ–™</button>
        <p style="text-align:center; font-size:12px; color:#999; margin-top:20px;">HES TECHS Â© 2026</p>
    </div>

    <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleFileSelect()">

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        // âš ï¸ é€™æ˜¯æ‚¨å‰›å‰›æä¾›çš„æœ€æ–° Script (åŒ…å« Folder ID)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec"; 

        let userProfile = null;
        let mySchedule = [];
        let currentUploadType = "";

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            checkLogin();
        }

        async function checkLogin() {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", userId: userProfile.userId })
                });
                const result = await res.json();

                document.getElementById("loading").classList.remove("active");
                document.getElementById("main-page").classList.add("active");
                document.getElementById("form-avatar").src = userProfile.pictureUrl;
                document.getElementById("form-name").innerText = userProfile.displayName;

                if (result.isRegistered) {
                    // èˆŠç”¨æˆ¶ï¼šå¡«å…¥è³‡æ–™
                    document.getElementById("page-title").innerText = "ç·¨è¼¯å€‹äººæª”æ¡ˆ";
                    const d = result.data;
                    document.getElementById("inp-rate").value = d.rate;
                    document.getElementById("inp-tags").value = d.tags;
                    document.getElementById("inp-intro").value = d.intro;
                    document.getElementById("inp-bank").value = d.bank;
                    document.getElementById("inp-online-status").value = d.status;
                    
                    // æ¢å¾©æ’ç¨‹
                    try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule=[]; }
                    renderSchedule();

                    // æ›´æ–°é©—è­‰ç‹€æ…‹ UI
                    if(d.verified === "Verified") {
                        document.getElementById("form-status").innerText = "å·²èªè­‰";
                        document.getElementById("form-status").className = "badge badge-green";
                    } else if (d.verified === "Pending Review") {
                        document.getElementById("form-status").innerText = "å¯©æ ¸ä¸­";
                        document.getElementById("form-status").className = "badge badge-orange";
                    }

                    // æ›´æ–°æ–‡ä»¶ä¸Šå‚³ç‹€æ…‹
                    if(d.docFront) updateDocUI('front', d.docFront);
                    if(d.docBack) updateDocUI('back', d.docBack);
                    if(d.docPolice) updateDocUI('police', d.docPolice);

                } else {
                    // æ–°ç”¨æˆ¶
                    document.getElementById("page-title").innerText = "æ­¡è¿åŠ å…¥ï¼";
                    alert("è«‹å®Œæˆä¸‹æ–¹è³‡æ–™ä»¥å»ºç«‹æª”æ¡ˆ");
                }
            } catch (err) {
                alert("é€£ç·šéŒ¯èª¤ï¼š" + err);
            }
        }

        // --- æ™‚æ®µåŠŸèƒ½ ---
        function addSlot() {
            const day = document.getElementById("sel-day").value;
            const time = document.getElementById("sel-time").value;
            const slot = `${day} ${time}`;
            if (!mySchedule.includes(slot)) {
                mySchedule.push(slot);
                // ç°¡å–®æ’åº
                const dayOrder = {"é€±ä¸€":1, "é€±äºŒ":2, "é€±ä¸‰":3, "é€±å››":4, "é€±äº”":5, "é€±å…­":6, "é€±æ—¥":7};
                mySchedule.sort((a,b) => dayOrder[a.substr(0,2)] - dayOrder[b.substr(0,2)]);
                renderSchedule();
            }
        }
        function removeSlot(index) {
            mySchedule.splice(index, 1);
            renderSchedule();
        }
        function renderSchedule() {
            const container = document.getElementById("schedule-list");
            container.innerHTML = "";
            mySchedule.forEach((slot, index) => {
                const div = document.createElement("div");
                div.className = "time-slot";
                div.innerHTML = `<span>ğŸ•’ ${slot}</span> <span class="btn-del" onclick="removeSlot(${index})">âœ•</span>`;
                container.appendChild(div);
            });
        }

        // --- ä¸Šå‚³åŠŸèƒ½ ---
        function triggerUpload(type) {
            currentUploadType = type;
            document.getElementById("file-input").click();
        }
        function handleFileSelect() {
            const file = document.getElementById("file-input").files[0];
            if (!file) return;

            const btn = document.querySelector(`button[onclick="triggerUpload('${currentUploadType}')"]`);
            btn.innerText = "ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Data = reader.result.split(',')[1];
                const payload = {
                    action: "uploadDoc",
                    userId: userProfile.userId,
                    docType: currentUploadType,
                    fileName: `${userProfile.displayName}_${currentUploadType}.jpg`,
                    mimeType: file.type,
                    fileData: base64Data
                };
                try {
                    const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
                    const result = await res.json();
                    if (result.success) {
                        alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
                        updateDocUI(currentUploadType, result.url);
                    } else { alert("ä¸Šå‚³å¤±æ•—"); }
                } catch (e) { alert("éŒ¯èª¤ï¼š" + e); } 
                finally { btn.innerText = "é‡æ–°ä¸Šå‚³"; btn.disabled = false; }
            };
        }
        function updateDocUI(type, url) {
            document.getElementById("icon-" + type).className = "check-icon done";
            document.getElementById("icon-" + type).innerText = "âœ”";
            const link = document.getElementById("link-" + type);
            link.href = url;
            link.style.display = "inline-block";
        }

        // --- å„²å­˜è³‡æ–™ ---
        async function saveProfile() {
            const btn = document.querySelector(".btn-main");
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            const data = {
                action: "updateProfile",
                userId: userProfile.userId,
                name: userProfile.displayName,
                photo: userProfile.pictureUrl,
                rate: document.getElementById("inp-rate").value,
                tags: document.getElementById("inp-tags").value,
                intro: document.getElementById("inp-intro").value,
                bank: document.getElementById("inp-bank").value,
                status: document.getElementById("inp-online-status").value,
                schedule: JSON.stringify(mySchedule)
            };

            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
                alert("âœ… è³‡æ–™æ›´æ–°æˆåŠŸï¼");
                btn.innerText = "å„²å­˜ä¸¦æ›´æ–°è³‡æ–™";
                btn.disabled = false;
            } catch(e) { alert("å¤±æ•—ï¼š" + e); }
        }

        main();
    </script>
</body>
</html>
