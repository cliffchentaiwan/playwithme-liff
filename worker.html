<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¥ä¼´å¾Œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; color: #555; }
        .btn-save { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; flex-direction: column; }
        
        .time-item { background: #e3f2fd; color: #1565c0; padding: 8px 12px; border-radius: 6px; margin: 5px 0; text-align: left; font-size: 14px; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size: 40px;">ğŸš€</div>
    <div style="margin-top: 10px; color: #666;">è®€å–ä¸­...</div>
</div>

<div class="card">
    <img id="my-avatar" class="avatar" src="https://via.placeholder.com/80">
    <h2 id="my-name" style="margin: 0;">...</h2>
    <div style="font-size: 13px; color: #888; margin-top: 5px;">é™ªç©å¤¥ä¼´è¨­å®š</div>
</div>

<div class="card" style="text-align:left;">
    <label>æ™‚è–ª (TWD)</label><input type="number" id="inp-rate">
    <label>å°ˆé•·æ¨™ç±¤</label><input type="text" id="inp-tags" placeholder="ä¾‹å¦‚: ç•«ç•«, é‹¼ç´">
    <label>è‡ªæˆ‘ä»‹ç´¹</label><textarea id="inp-intro" rows="3"></textarea>
    <label>éŠ€è¡Œå¸³è™Ÿ</label><input type="text" id="inp-bank">
    
    <label>æ’ç­è¨­å®š</label>
    <div style="display:flex;gap:10px;">
        <select id="sel-day"><option>é€±ä¸€</option><option>é€±äºŒ</option><option>é€±ä¸‰</option><option>é€±å››</option><option>é€±äº”</option><option>é€±å…­</option><option>é€±æ—¥</option></select>
        <select id="sel-time"><option>09:00</option><option>13:00</option><option>19:00</option></select>
        <button onclick="addTime()" style="width: 50px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 20px;">+</button>
    </div>
    <div id="schedule-box" style="margin-top:10px;"></div>
</div>

<button class="btn-save" onclick="saveData()">å„²å­˜ä¸¦ä¸Šç·š</button>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // âš ï¸ å‹™å¿…ç¢ºèªé€™æ˜¯æ‚¨æœ€æ–°éƒ¨ç½²çš„ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    
    let userProfile, mySchedule = [];

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            
            document.getElementById("my-avatar").src = userProfile.pictureUrl;
            document.getElementById("my-name").innerText = userProfile.displayName;
            
            // ç™»å…¥ä¸¦è®€å–è³‡æ–™
            let res = await fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" }, // é—œéµä¿®æ­£
                body: JSON.stringify({ action: "login", userId: userProfile.userId })
            });
            let json = await res.json();
            document.getElementById("loading").style.display = "none";

            if (json.isRegistered) {
                let d = json.data;
                document.getElementById("inp-rate").value = d.rate;
                document.getElementById("inp-tags").value = d.tags;
                document.getElementById("inp-intro").value = d.intro;
                document.getElementById("inp-bank").value = d.bank;
                try { mySchedule = JSON.parse(d.schedule); renderSchedule(); } catch(e){}
            }
        } catch(e) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + e);
            document.getElementById("loading").style.display = "none";
        }
    };

    function addTime() {
        let t = document.getElementById("sel-day").value + " " + document.getElementById("sel-time").value;
        if(!mySchedule.includes(t)) { mySchedule.push(t); renderSchedule(); }
    }

    function removeTime(idx) {
        mySchedule.splice(idx, 1);
        renderSchedule();
    }

    function renderSchedule() {
        let box = document.getElementById("schedule-box");
        box.innerHTML = "";
        mySchedule.forEach((s, i) => {
            box.innerHTML += `<div class="time-item">${s} <span onclick="removeTime(${i})" style="float:right;color:red;cursor:pointer;">Ã—</span></div>`;
        });
    }

    async function saveData() {
        let btn = document.querySelector(".btn-save");
        btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;
        
        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" }, // é—œéµä¿®æ­£
                body: JSON.stringify({
                    action: "updateProfile",
                    userId: userProfile.userId,
                    name: userProfile.displayName,
                    photo: userProfile.pictureUrl,
                    rate: document.getElementById("inp-rate").value,
                    tags: document.getElementById("inp-tags").value,
                    intro: document.getElementById("inp-intro").value,
                    bank: document.getElementById("inp-bank").value,
                    schedule: JSON.stringify(mySchedule)
                })
            });
            alert("âœ… å„²å­˜æˆåŠŸï¼");
        } catch(e) {
            alert("å„²å­˜å¤±æ•—: " + e);
        }
        btn.innerText = "å„²å­˜ä¸¦ä¸Šç·š"; btn.disabled = false;
    }
</script>
</body>
</html>
