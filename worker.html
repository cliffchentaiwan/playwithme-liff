<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孩友友 (夥伴端)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #eee; margin-bottom: 10px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        label { display: block; text-align: left; font-weight: bold; font-size: 14px; margin-top: 10px; }
        .btn-save { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }
        
        .time-item { background: #e3f2fd; padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:2000; }
    </style>
</head>
<body>

<div id="loading">讀取資料中...</div>

<div class="card">
    <img id="my-avatar" class="avatar" src="">
    <h2 id="my-name">...</h2>
    <div id="status-badge" style="background:#eee; padding:5px; display:inline-block; border-radius:5px; font-size:12px;">讀取中</div>
</div>

<div class="card" style="text-align:left;">
    <label>時薪</label>
    <input type="number" id="inp-rate">
    
    <label>標籤 (逗號分隔)</label>
    <input type="text" id="inp-tags">
    
    <label>自我介紹</label>
    <textarea id="inp-intro"></textarea>
    
    <label>排班設定</label>
    <div style="display:flex; gap:5px;">
        <select id="sel-day"><option>週一</option><option>週二</option><option>週三</option><option>週四</option><option>週五</option><option>週六</option><option>週日</option></select>
        <select id="sel-time"><option>09:00</option><option>10:00</option><option>13:00</option><option>14:00</option><option>15:00</option><option>19:00</option></select>
        <button onclick="addTime()" style="width:50px;">+</button>
    </div>
    <div id="schedule-box" style="margin-top:10px;"></div>
</div>

<button class="btn-save" onclick="saveData()">儲存資料</button>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // 直接放入您確認過正確的網址
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";

    let userProfile = null;
    let mySchedule = [];

    window.onload = async function() {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        
        // 顯示基本資料
        document.getElementById("my-avatar").src = userProfile.pictureUrl;
        document.getElementById("my-name").innerText = userProfile.displayName;
        
        fetchData();
    };

    async function fetchData() {
        try {
            let res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", userId: userProfile.userId })
            });
            let json = await res.json();
            document.getElementById("loading").style.display = "none";
            
            if(json.isRegistered) {
                let d = json.data;
                document.getElementById("inp-rate").value = d.rate;
                document.getElementById("inp-tags").value = d.tags;
                document.getElementById("inp-intro").value = d.intro;
                document.getElementById("status-badge").innerText = d.verified === "Verified" ? "✅ 已認證" : "審核中";
                
                try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule = []; }
                renderSchedule();
            } else {
                document.getElementById("status-badge").innerText = "新用戶";
            }
        } catch(e) {
            alert("連線錯誤: " + e);
            document.getElementById("loading").style.display = "none";
        }
    }

    function addTime() {
        let t = document.getElementById("sel-day").value + " " + document.getElementById("sel-time").value;
        if(!mySchedule.includes(t)) {
            mySchedule.push(t);
            renderSchedule();
        }
    }

    function renderSchedule() {
        let box = document.getElementById("schedule-box");
        box.innerHTML = "";
        mySchedule.forEach((s, i) => {
            box.innerHTML += `<div class="time-item">${s} <span onclick="mySchedule.splice(${i},1);renderSchedule()" style="color:red;cursor:pointer;">x</span></div>`;
        });
    }

    async function saveData() {
        let btn = document.querySelector(".btn-save");
        btn.innerText = "儲存中..."; btn.disabled = true;
        
        let data = {
            action: "updateProfile",
            userId: userProfile.userId,
            name: userProfile.displayName,
            photo: userProfile.pictureUrl,
            rate: document.getElementById("inp-rate").value,
            tags: document.getElementById("inp-tags").value,
            intro: document.getElementById("inp-intro").value,
            status: "Online",
            schedule: JSON.stringify(mySchedule)
        };

        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
            alert("儲存成功！");
        } catch(e) {
            alert("失敗: " + e);
        }
        btn.innerText = "儲存資料"; btn.disabled = false;
    }
</script>
</body>
</html>
