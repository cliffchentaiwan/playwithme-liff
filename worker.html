<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å“¡å·¥ä½œå° (ä¿®å¾©ç‰ˆ)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #333; color: white; padding: 20px; text-align: center; padding-bottom: 60px; }
        .card { background: #444; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; color: #06c755; font-size: 20px; }
        p { color: #ccc; font-size: 14px; }
        .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        .btn:disabled { background-color: #666; cursor: not-allowed; }
        .btn-gps { background-color: #2196F3; color: white; }
        .btn-scan { background-color: #06c755; color: white; }
        .status-box { background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; color: #aaa; text-align: left; min-height: 20px; word-break: break-all; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #06c755; margin-bottom: 10px; }
        /* éŒ¯èª¤è¨Šæ¯å°ˆç”¨å€ */
        #debug-console { color: #ff5555; background: #000; padding: 10px; margin-bottom: 20px; border: 1px solid #ff5555; display: none; text-align: left; font-size: 12px; }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div id="profile">
        <div class="card">
            <p id="loading-text">æ­£åœ¨é€£æ¥ LINE ç³»çµ±...</p>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ æŠµé”æ‰“å¡</h2>
        <p>åˆ°é”æŒ‡å®šåœ°é»å¾Œï¼Œè«‹é»æ“Šå›å ±ã€‚</p>
        <button class="btn btn-gps" id="btn-gps" onclick="handleGPS()">å‚³é€ GPS ä½ç½®</button>
        <div class="status-box" id="gps-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="card">
        <h2>ğŸ“¸ å®Œå·¥æƒç¢¼</h2>
        <p>è«‹æƒæå®¶é•·æ‰‹æ©Ÿä¸Šçš„ QR Code ä»¥çµæ¡ˆã€‚</p>
        <button class="btn btn-scan" id="btn-scan" onclick="handleScan()">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
        <div class="status-box" id="scan-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // é¡¯ç¤ºéŒ¯èª¤çš„å·¥å…·
        function logError(msg) {
            const debugBox = document.getElementById("debug-console");
            debugBox.style.display = "block";
            debugBox.innerHTML += "âš ï¸ " + msg + "<br>";
        }
        window.onerror = function(message, source, lineno, colno, error) {
            logError(`ç³»çµ±éŒ¯èª¤: ${message} (Line: ${lineno})`);
        };

        const LIFF_ID = "2008808827-DzeTt84n"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbwfs3NTl9VmGiqcZZ_bXjwOFvOJsyCeKWiYSuAGC3Q9BNYxk1fmxktF-LkNAzvP94Zk/exec";
        
        let userProfile = null;

        async function main() {
            try {
                document.getElementById("loading-text").innerText = "1. åˆå§‹åŒ– LIFF...";
                await liff.init({ liffId: LIFF_ID });
                
                document.getElementById("loading-text").innerText = "2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹...";
                if (!liff.isLoggedIn()) {
                    document.getElementById("loading-text").innerText = "æœªç™»å…¥ï¼Œè·³è½‰ä¸­...";
                    liff.login();
                    return;
                }

                document.getElementById("loading-text").innerText = "3. è®€å–å€‹äººè³‡æ–™...";
                userProfile = await liff.getProfile();
                
                // æˆåŠŸè¼‰å…¥ï¼
                document.getElementById("profile").innerHTML = `
                    <div class="card">
                        <img src="${userProfile.pictureUrl}" class="profile-img">
                        <h3>${userProfile.displayName}</h3>
                        <p>ğŸŸ¢ ç³»çµ±é€£ç·šæ­£å¸¸</p>
                    </div>
                `;
                
                if (!liff.isInClient()) {
                    document.getElementById("btn-scan").disabled = true;
                    document.getElementById("scan-status").innerText = "âš ï¸ æƒç¢¼åŠŸèƒ½éœ€åœ¨ LINE App å…§ä½¿ç”¨";
                }

            } catch (err) {
                logError("å•Ÿå‹•å¤±æ•—: " + err.message);
                document.getElementById("loading-text").innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹çœ‹ä¸Šæ–¹ç´…å­—";
            }
        }

        // 1. GPS æ‰“å¡åŠŸèƒ½
        function handleGPS() {
            const statusBox = document.getElementById("gps-status");
            const btn = document.getElementById("btn-gps");
            
            if (!navigator.geolocation) {
                statusBox.innerText = "æ­¤è£ç½®ä¸æ”¯æ´ GPS";
                return;
            }

            btn.disabled = true;
            btn.innerText = "å®šä½ä¸­...";
            statusBox.innerText = "æ­£åœ¨æŠ“å–åº§æ¨™...";

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    const locString = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    statusBox.innerHTML = `âœ… å®šä½æˆåŠŸï¼š${locString}`;
                    
                    // å‚³é€è³‡æ–™
                    sendToSheet("GPSæ‰“å¡", locString);
                    
                    // èŠå¤©å®¤å›å ± (åŠ å¼·é˜²å‘†ï¼Œé¿å… userProfile ç‚ºç©ºæ™‚ç•¶æ©Ÿ)
                    if (liff.isInClient() && userProfile) {
                        liff.sendMessages([{
                            type: 'text',
                            text: `ã€æ‰“å¡å›å ±ã€‘\næˆ‘æ˜¯ ${userProfile.displayName}ï¼Œæˆ‘å·²æŠµé”ç¾å ´ï¼\nğŸ“ åº§æ¨™ï¼š${locString}`
                        }]).catch(err => logError("è¨Šæ¯ç™¼é€å¤±æ•—:" + err));
                    }
                    btn.innerText = "å·²æ‰“å¡";
                    btn.disabled = false;
                },
                (err) => {
                    statusBox.innerText = "å®šä½å¤±æ•—: " + err.message;
                    logError("GPS éŒ¯èª¤: " + err.message);
                    btn.disabled = false;
                    btn.innerText = "å‚³é€ GPS ä½ç½®";
                }
            );
        }

        // 2. æƒç¢¼åŠŸèƒ½
        async function handleScan() {
            const statusBox = document.getElementById("scan-status");
            try {
                if (!liff.isInClient()) {
                    alert("è«‹åœ¨æ‰‹æ©Ÿ LINE ä¸­é–‹å•Ÿæ‰èƒ½æƒæ");
                    return;
                }
                const result = await liff.scanCodeV2();
                if (result.value) {
                    statusBox.innerText = "âœ… æƒææˆåŠŸ: " + result.value;
                    sendToSheet("å®Œå·¥æƒç¢¼", "ä»£ç¢¼:" + result.value);
                    alert("æƒææˆåŠŸï¼");
                }
            } catch (err) {
                statusBox.innerText = "æƒæå–æ¶ˆæˆ–å¤±æ•—";
                logError("æƒç¢¼éŒ¯èª¤: " + err);
            }
        }

        function sendToSheet(actionType, detail) {
            const name = userProfile ? userProfile.displayName : "æœªçŸ¥äººå“¡";
            const data = {
                userName: name,
                companion: actionType, 
                price: detail
            };

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "text/plain" }
            }).then(() => {
                console.log("è³‡æ–™å·²é€å‡º");
            }).catch(err => {
                logError("è³‡æ–™åº«é€£ç·šå¤±æ•—: " + err);
            });
        }

        main();
    </script>
</body>
</html>
