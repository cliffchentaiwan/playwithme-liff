<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å¤¥ä¼´å¾Œå° (V7.0)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; display: block; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin: 0 0 5px 0; font-size: 20px; }
        .status-badge { text-align: center; margin-bottom: 20px; font-size: 13px; color: #666; background: #eee; display: inline-block; padding: 4px 12px; border-radius: 12px; }
        
        label { display: block; font-weight: bold; margin: 15px 0 5px; font-size: 14px; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 15px; }
        
        .time-slot { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
        .btn-del { color: #d32f2f; font-weight: bold; cursor: pointer; padding: 5px; }
        
        .btn-main { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn-main:disabled { background: #ccc; }
        
        /* è¨‚å–®å¡ç‰‡ */
        .order-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card.Pending { border-left-color: #ff9800; }
        .order-card.Paid { border-left-color: #f1c40f; }
        .order-card.Accepted { border-left-color: #2196f3; }
        
        .btn-action { padding: 8px 12px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; margin-right: 5px; color: white; }
        .btn-accept { background: #2196f3; }
        .btn-reject { background: #f44336; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loading">ğŸš€ ç³»çµ±è¼‰å…¥ä¸­...</div>

<div class="card" style="text-align:center;">
    <img id="form-avatar" class="avatar" src="https://via.placeholder.com/80">
    <h2 id="form-name">è¼‰å…¥ä¸­...</h2>
    <span id="form-status" class="status-badge">æª¢æŸ¥ä¸­...</span>
</div>

<div class="card">
    <h3>ğŸ“ åŸºæœ¬è³‡æ–™</h3>
    <label>æ™‚è–ª (TWD)</label>
    <input type="number" id="inp-rate" placeholder="ä¾‹å¦‚: 300">
    
    <label>æ¨™ç±¤ (ç”¨é€—è™Ÿåˆ†éš”)</label>
    <input type="text" id="inp-tags" placeholder="ç•«ç•«, é‹¼ç´, é‹å‹•">
    
    <label>è‡ªæˆ‘ä»‹ç´¹</label>
    <textarea id="inp-intro" rows="3"></textarea>
    
    <label>éŠ€è¡Œå¸³è™Ÿ (åŒ¯æ¬¾ç”¨)</label>
    <input type="text" id="inp-bank">
</div>

<div class="card">
    <h3>ğŸ“… æ’ç­è¨­å®š</h3>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="sel-day" style="flex:1">
            <option value="é€±ä¸€">é€±ä¸€</option><option value="é€±äºŒ">é€±äºŒ</option><option value="é€±ä¸‰">é€±ä¸‰</option>
            <option value="é€±å››">é€±å››</option><option value="é€±äº”">é€±äº”</option><option value="é€±å…­">é€±å…­</option><option value="é€±æ—¥">é€±æ—¥</option>
        </select>
        <select id="sel-time" style="flex:1">
            </select>
        <button onclick="addSlot()" style="background:#1976d2; color:white; border:none; border-radius:8px; width:50px;">+</button>
    </div>
    <div id="schedule-list"></div>
</div>

<div class="card">
    <h3>ğŸ“‹ æ¥å–®ç®¡ç†</h3>
    <div id="order-list">
        <p style="color:#999; text-align:center;">è¼‰å…¥è¨‚å–®ä¸­...</p>
    </div>
</div>

<button class="btn-main" onclick="saveProfile()">å„²å­˜ä¸¦æ›´æ–°è³‡æ–™</button>

<script>
    // âœ… å·²åµŒå…¥æ‚¨æä¾›çš„æ­£ç¢ºç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    const LIFF_ID = "2008808827-DzeTt84n"; 

    let userProfile = null;
    let mySchedule = [];

    // åˆå§‹åŒ–æ™‚æ®µé¸é …
    const timeSel = document.getElementById("sel-time");
    for(let i=8; i<=22; i++) {
        let h = i < 10 ? "0"+i : i;
        timeSel.innerHTML += `<option value="${h}:00">${h}:00</option>`;
    }

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            
            checkLogin();
        } catch(e) {
            alert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID: " + e);
            document.getElementById("loading").style.display = "none";
        }
    };

    async function checkLogin() {
        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", userId: userProfile.userId })
            });
            const result = await res.json();
            document.getElementById("loading").style.display = "none";
            
            // å„ªå…ˆé¡¯ç¤º LINE ç…§ç‰‡
            document.getElementById("form-avatar").src = userProfile.pictureUrl || "https://via.placeholder.com/80";
            document.getElementById("form-name").innerText = userProfile.displayName;

            if(result.isRegistered) {
                const d = result.data;
                document.getElementById("inp-rate").value = d.rate;
                document.getElementById("inp-tags").value = d.tags;
                document.getElementById("inp-intro").value = d.intro;
                document.getElementById("inp-bank").value = d.bank;
                document.getElementById("form-status").innerText = d.verified === "Verified" ? "âœ… å·²èªè­‰ä¸Šæ¶" : "â³ è³‡æ–™å¯©æ ¸ä¸­";
                
                try { mySchedule = JSON.parse(d.schedule); } catch(e){ mySchedule = []; }
                renderSchedule();
                
                loadMyOrders(d.name); // è¼‰å…¥è¨‚å–®
            } else {
                document.getElementById("form-status").innerText = "ğŸ‘‹ æ­¡è¿æ–°å¤¥ä¼´ï¼Œè«‹å¡«å¯«è³‡æ–™";
                document.getElementById("form-status").style.background = "#fff3e0";
            }
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤ (è«‹ç¢ºèªå¾Œå°å·²å»ºç«‹æ–°ç‰ˆæœ¬): " + e);
            document.getElementById("loading").style.display = "none";
        }
    }

    // æ’ç­é‚è¼¯
    function addSlot() {
        const slot = `${document.getElementById("sel-day").value} ${document.getElementById("sel-time").value}`;
        if(!mySchedule.includes(slot)) {
            mySchedule.push(slot);
            mySchedule.sort();
            renderSchedule();
        }
    }
    function removeSlot(idx) {
        mySchedule.splice(idx, 1);
        renderSchedule();
    }
    function renderSchedule() {
        const div = document.getElementById("schedule-list");
        div.innerHTML = "";
        mySchedule.forEach((s, i) => {
            div.innerHTML += `<div class="time-slot"><span>${s}</span><span class="btn-del" onclick="removeSlot(${i})">&times;</span></div>`;
        });
    }

    // å„²å­˜è³‡æ–™
    async function saveProfile() {
        const btn = document.querySelector(".btn-main");
        btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;

        const data = {
            action: "updateProfile",
            userId: userProfile.userId,
            name: userProfile.displayName,
            photo: userProfile.pictureUrl,
            rate: document.getElementById("inp-rate").value,
            tags: document.getElementById("inp-tags").value,
            intro: document.getElementById("inp-intro").value,
            bank: document.getElementById("inp-bank").value,
            status: "Online", // é è¨­ä¸Šæ¶
            schedule: JSON.stringify(mySchedule)
        };

        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
            alert("âœ… è³‡æ–™æ›´æ–°æˆåŠŸï¼");
        } catch(e) {
            alert("æ›´æ–°å¤±æ•—ï¼š" + e);
        } finally {
            btn.innerText = "å„²å­˜ä¸¦æ›´æ–°è³‡æ–™"; btn.disabled = false;
        }
    }

    // è¨‚å–®ç®¡ç†
    async function loadMyOrders(myName) {
        const list = document.getElementById("order-list");
        const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getMyOrders", workerName: myName, role: "worker" })
        });
        const data = await res.json();
        
        if(!data.orders || data.orders.length === 0) {
            list.innerHTML = "<p style='text-align:center;color:#999;'>ç›®å‰æ²’æœ‰æ–°è¨‚å–®</p>";
            return;
        }

        let html = "";
        data.orders.forEach(o => {
            let btns = "";
            let statusClass = "Pending";
            
            if(o.status === "Paid") {
                statusClass = "Paid";
                btns = `
                    <button class="btn-action btn-accept" onclick="updateOrder(${o.row}, 'å·²æ¥å–®')">æ¥å–®</button>
                    <button class="btn-action btn-reject" onclick="updateOrder(${o.row}, 'å·²æ‹’çµ•')">æ‹’çµ•</button>
                `;
            } else if(o.status === "å·²æ¥å–®") {
                statusClass = "Accepted";
                btns = `<span style="color:#2196f3; font-weight:bold;">å·²æ¥å–®ï¼Œæº–å‚™æœå‹™</span>`;
            } else if(o.status === "å·²æ‹’çµ•") {
                btns = `<span style="color:red;">å·²æ‹’çµ•æ­¤å–®</span>`;
            }

            html += `
                <div class="order-card ${statusClass}">
                    <div style="font-weight:bold; margin-bottom:5px;">å®¶é•·ï¼š${o.parent}</div>
                    <div style="font-size:14px;">æ™‚é–“ï¼š${o.bookingTime}</div>
                    <div style="font-size:14px;">å‚™è¨»ï¼š${o.note}</div>
                    <div style="margin-top:10px;">${btns}</div>
                </div>
            `;
        });
        list.innerHTML = html;
    }

    async function updateOrder(row, status) {
        if(!confirm(`ç¢ºå®šè¦${status}å—ï¼Ÿ`)) return;
        await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "updateOrderStatus", row: row, newStatus: status })
        });
        alert("æ›´æ–°æˆåŠŸ");
        location.reload();
    }
</script>
</body>
</html>
