<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å“¡å·¥ä½œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #333; color: white; padding: 20px; text-align: center; padding-bottom: 60px; }
        .card { background: #444; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; color: #06c755; font-size: 20px; }
        p { color: #ccc; font-size: 14px; }
        .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        .btn:disabled { background-color: #666; cursor: not-allowed; }
        .btn-gps { background-color: #2196F3; color: white; }
        .btn-gps:active { background-color: #1976D2; }
        .btn-scan { background-color: #06c755; color: white; }
        .btn-scan:active { background-color: #05a546; }
        .status-box { background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; color: #aaa; text-align: left; min-height: 20px; word-break: break-all; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #06c755; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="profile">
        <div class="card">
            <p>æ­£åœ¨è®€å–èº«ä»½...</p>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ æŠµé”æ‰“å¡</h2>
        <p>åˆ°é”æŒ‡å®šåœ°é»å¾Œï¼Œè«‹é»æ“Šå›å ±ã€‚</p>
        <button class="btn btn-gps" id="btn-gps" onclick="handleGPS()">å‚³é€ GPS ä½ç½®</button>
        <div class="status-box" id="gps-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="card">
        <h2>ğŸ“¸ å®Œå·¥æƒç¢¼</h2>
        <p>è«‹æƒæå®¶é•·æ‰‹æ©Ÿä¸Šçš„ QR Code ä»¥çµæ¡ˆã€‚</p>
        <button class="btn btn-scan" id="btn-scan" onclick="handleScan()">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
        <div class="status-box" id="scan-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        // ä½ çš„ Google Script ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwfs3NTl9VmGiqcZZ_bXjwOFvOJsyCeKWiYSuAGC3Q9BNYxk1fmxktF-LkNAzvP94Zk/exec";
        
        let userProfile = null;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login(); return;
                }
                userProfile = await liff.getProfile();
                document.getElementById("profile").innerHTML = `
                    <div class="card">
                        <img src="${userProfile.pictureUrl}" class="profile-img">
                        <h3>${userProfile.displayName}</h3>
                        <p>ğŸŸ¢ ç‹€æ…‹ï¼šå·¥ä½œä¸­</p>
                    </div>
                `;
                
                if (!liff.isInClient()) {
                    document.getElementById("btn-scan").disabled = true;
                    document.getElementById("scan-status").innerText = "âš ï¸ æƒç¢¼åŠŸèƒ½éœ€åœ¨ LINE App å…§ä½¿ç”¨";
                }
            } catch (err) {
                alert("åˆå§‹åŒ–éŒ¯èª¤ï¼š" + err);
            }
        }

        // 1. GPS æ‰“å¡åŠŸèƒ½
        function handleGPS() {
            const statusBox = document.getElementById("gps-status");
            const btn = document.getElementById("btn-gps");
            
            if (!navigator.geolocation) {
                statusBox.innerText = "æ­¤è£ç½®ä¸æ”¯æ´ GPS";
                return;
            }

            btn.disabled = true;
            btn.innerText = "å®šä½ä¸­...";
            statusBox.innerText = "æ­£åœ¨æŠ“å–åº§æ¨™...";

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    const locString = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    statusBox.innerHTML = `âœ… å®šä½æˆåŠŸï¼š${locString}`;
                    
                    // å‚³é€è³‡æ–™åˆ° Google Sheet
                    sendToSheet("GPSæ‰“å¡", locString);
                    
                    // (é¸ç”¨) åœ¨èŠå¤©å®¤å›å ±
                    if (liff.isInClient()) {
                        liff.sendMessages([{
                            type: 'text',
                            text: `ã€æ‰“å¡å›å ±ã€‘\næˆ‘æ˜¯
