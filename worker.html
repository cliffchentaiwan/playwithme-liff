<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¥ä¼´å·¥ä½œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* APP é¢¨æ ¼åŸºç¤è¨­å®š */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: white; margin: 0; padding: 0; padding-bottom: 80px; }
        
        /* é ‚éƒ¨è³‡è¨Šå¡ */
        .header-card { background: linear-gradient(135deg, #06c755, #04a044); padding: 25px 20px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3); display: flex; align-items: center; }
        .profile-img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; margin-right: 15px; }
        .header-info h2 { margin: 0; font-size: 20px; }
        .header-info p { margin: 5px 0 0; opacity: 0.9; font-size: 14px; }
        
        /* åˆ†é å…§å®¹å€ */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: #1e1e1e; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card h3 { margin-top: 0; color: #06c755; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }

        /* è¨‚å–®åˆ—è¡¨æ¨£å¼ */
        .order-item { border-left: 4px solid #06c755; background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .order-time { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .order-detail { font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; }
        .order-status { font-size: 12px; background: #444; padding: 3px 8px; border-radius: 10px; }

        /* è¡¨å–®æ¨£å¼ */
        label { display: block; margin-bottom: 8px; color: #ccc; font-size: 14px; }
        input, textarea { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        textarea { resize: none; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: #06c755; color: white; }
        .btn-secondary { background-color: #333; color: white; margin-top: 10px; }
        
        /* åº•éƒ¨å°èˆªåˆ— */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #1e1e1e; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; z-index: 100; }
        .nav-item { color: #888; text-align: center; font-size: 12px; cursor: pointer; flex: 1; }
        .nav-item.active { color: #06c755; }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* é–‹é—œæ¨£å¼ */
        .toggle-btn { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .is-online { background: rgba(6, 199, 85, 0.2); color: #06c755; border: 1px solid #06c755; }
        .is-offline { background: #333; color: #888; border: 1px solid #555; }

    </style>
</head>
<body>

    <div class="header-card">
        <img id="head-img" src="" class="profile-img">
        <div class="header-info">
            <h2 id="head-name">è¼‰å…¥ä¸­...</h2>
            <p id="head-status">æº–å‚™é–‹å§‹å·¥ä½œ</p>
        </div>
    </div>

    <div id="tab-home" class="tab-content active">
        <div id="status-toggle" class="toggle-btn is-offline" onclick="toggleStatus()">
            ğŸ”´ ç›®å‰é›¢ç·šä¸­ (é»æ­¤ä¸Šç·š)
        </div>

        <div class="card">
            <h3>ğŸ“‹ ä»»å‹™æ¸…å–® (Checklist)</h3>
            <div id="order-list">
                <p style="text-align:center; color:#666; padding:20px;">è¼‰å…¥è¨‚å–®ä¸­...</p>
            </div>
        </div>
    </div>

    <div id="tab-profile" class="tab-content">
        <div class="card">
            <h3>ğŸ‘¤ ç·¨è¼¯å€‹äººè³‡æ–™</h3>
            <label>æ¯å°æ™‚è²»ç‡ ($)</label>
            <input type="number" id="edit-rate">
            
            <label>å°ˆé•·æ¨™ç±¤</label>
            <input type="text" id="edit-tags" placeholder="#ç•«ç•«, #é‹¼ç´">
            
            <label>è‡ªæˆ‘ä»‹ç´¹</label>
            <textarea id="edit-intro" rows="4"></textarea>

            <button class="btn btn-primary" onclick="saveProfile()">å„²å­˜ä¿®æ”¹</button>
        </div>
        
        <div class="card">
            <h3>âš™ï¸ ç³»çµ±åŠŸèƒ½</h3>
            <button class="btn btn-secondary" onclick="handleScan()">ğŸ“¸ å®Œå·¥æƒç¢¼</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">ğŸ </span>
            æ¥å–®ä»»å‹™
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <span class="nav-icon">ğŸ‘¤</span>
            å€‹äººæª”æ¡ˆ
        </div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec"; // è¨˜å¾—ç¢ºèªç¶²å€
        
        let userProfile = null;
        let isOnline = false;

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            
            // æ¸²æŸ“é ­åƒ
            document.getElementById("head-img").src = userProfile.pictureUrl;
            document.getElementById("head-name").innerText = userProfile.displayName;

            // è®€å–è³‡æ–™
            loadMyData();
            loadMyOrders();
        }

        // åˆ‡æ›åˆ†é 
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // è®€å–å€‹äººè³‡æ–™ (å¡«å…¥è¡¨å–®)
        async function loadMyData() {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getProfile", userId: userProfile.userId })
            });
            const data = await res.json();
            
            if (data.notFound) {
                document.getElementById("head-status").innerText = "æ–°å¤¥ä¼´ï¼Œè«‹å¡«å¯«è³‡æ–™";
            } else {
                // å¡«å…¥è¡¨å–®
                document.getElementById("edit-rate").value = data.rate;
                document.getElementById("edit-tags").value = data.tags;
                document.getElementById("edit-intro").value = data.intro;
                
                // è¨­å®šç‹€æ…‹
                isOnline = (data.status === "Online");
                renderStatusBtn();
            }
        }

        // è®€å–è¨‚å–®åˆ—è¡¨
        async function loadMyOrders() {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getMyOrders", userName: userProfile.displayName })
            });
            const orders = await res.json();
            
            const listDiv = document.getElementById("order-list");
            listDiv.innerHTML = "";

            if (orders.length === 0) {
                listDiv.innerHTML = "<p style='text-align:center; color:#666; padding:20px;'>ç›®å‰æ²’æœ‰æ–°è¨‚å–®</p>";
                return;
            }

            orders.forEach(o => {
                // æ ¼å¼åŒ–æ™‚é–“
                const date = new Date(o.time);
                const timeStr = (date.getMonth()+1) + "/" + date.getDate() + " " + date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();
                
                listDiv.innerHTML += `
                    <div class="order-item">
                        <div class="order-time">ğŸ“… ${timeStr}</div>
                        <div class="order-detail">
                            <span>å®¶é•·ï¼š${o.parent}</span>
                            <span style="color:#06c755">$${o.price}</span>
                        </div>
                        <div style="margin-top:5px; display:flex; justify-content:space-between;">
                             <span class="order-status">${o.status}</span>
                        </div>
                    </div>
                `;
            });
        }

        // å„²å­˜è³‡æ–™
        async function saveProfile() {
            const btn = document.querySelector(".btn-primary");
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            const data = {
                action: "updateProfile",
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                pictureUrl: userProfile.pictureUrl,
                rate: document.getElementById("edit-rate").value,
                tags: document.getElementById("edit-tags").value,
                intro: document.getElementById("edit-intro").value
            };

            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
            alert("âœ… è³‡æ–™å·²æ›´æ–°");
            btn.innerText = "å„²å­˜ä¿®æ”¹";
            btn.disabled = false;
        }

        // åˆ‡æ›ç‹€æ…‹
        function toggleStatus() {
            isOnline = !isOnline;
            renderStatusBtn();
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "toggleStatus", userId: userProfile.userId, status: isOnline ? "Online" : "Offline" })
            });
        }

        function renderStatusBtn() {
            const btn = document.getElementById("status-toggle");
            const txt = document.getElementById("head-status");
            if (isOnline) {
                btn.className = "toggle-btn is-online";
                btn.innerText = "ğŸŸ¢ ç›®å‰ç·šä¸Šæ¥å–®ä¸­ (é»æ­¤ä¼‘æ¯)";
                txt.innerText = "ç‹€æ…‹ï¼šå·¥ä½œä¸­ ğŸ’ª";
            } else {
                btn.className = "toggle-btn is-offline";
                btn.innerText = "ğŸ”´ ç›®å‰é›¢ç·šä¸­ (é»æ­¤ä¸Šç·š)";
                txt.innerText = "ç‹€æ…‹ï¼šä¼‘æ¯ä¸­ ğŸ’¤";
            }
        }
        
        // æƒç¢¼åŠŸèƒ½ (ä¿ç•™)
        async function handleScan() {
            if (!liff.isInClient()) { alert("è«‹åœ¨ LINE App ä½¿ç”¨"); return; }
            const res = await liff.scanCodeV2();
            if (res.value) alert("æƒæåˆ°ï¼š" + res.value);
        }

        main();
    </script>
</body>
</html>
