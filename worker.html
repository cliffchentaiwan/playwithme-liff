<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夥伴後台</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; }
        .btn-save { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body>

<div id="loading">讀取中...</div>

<div class="card">
    <img id="my-avatar" class="avatar" src="">
    <h2 id="my-name">...</h2>
</div>

<div class="card" style="text-align:left;">
    <label>時薪</label><input type="number" id="inp-rate">
    <label>標籤</label><input type="text" id="inp-tags">
    <label>介紹</label><textarea id="inp-intro"></textarea>
    <label>銀行</label><input type="text" id="inp-bank">
    <label>排班 (選完按+)</label>
    <div style="display:flex;gap:5px;">
        <select id="sel-day"><option>週一</option><option>週二</option><option>週三</option><option>週四</option><option>週五</option><option>週六</option><option>週日</option></select>
        <select id="sel-time"><option>09:00</option><option>13:00</option><option>19:00</option></select>
        <button onclick="addTime()">+</button>
    </div>
    <div id="schedule-box" style="margin-top:10px; color:#06c755;"></div>
</div>

<button class="btn-save" onclick="saveData()">儲存資料</button>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // ⚠️ 請確認這是剛剛 GAS 部署出來的網址
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    
    let userProfile, mySchedule = [];

    window.onload = async function() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        
        document.getElementById("my-avatar").src = userProfile.pictureUrl;
        document.getElementById("my-name").innerText = userProfile.displayName;
        
        // 登入並讀取資料
        let res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "login", userId: userProfile.userId })
        });
        let json = await res.json();
        document.getElementById("loading").style.display = "none";

        if (json.isRegistered) {
            let d = json.data;
            document.getElementById("inp-rate").value = d.rate;
            document.getElementById("inp-tags").value = d.tags;
            document.getElementById("inp-intro").value = d.intro;
            document.getElementById("inp-bank").value = d.bank;
            try { mySchedule = JSON.parse(d.schedule); renderSchedule(); } catch(e){}
        }
    };

    function addTime() {
        let t = document.getElementById("sel-day").value + " " + document.getElementById("sel-time").value;
        if(!mySchedule.includes(t)) { mySchedule.push(t); renderSchedule(); }
    }

    function renderSchedule() {
        document.getElementById("schedule-box").innerText = mySchedule.join(", ");
    }

    async function saveData() {
        let btn = document.querySelector(".btn-save");
        btn.innerText = "儲存中..."; btn.disabled = true;
        
        await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "updateProfile",
                userId: userProfile.userId,
                name: userProfile.displayName,
                photo: userProfile.pictureUrl,
                rate: document.getElementById("inp-rate").value,
                tags: document.getElementById("inp-tags").value,
                intro: document.getElementById("inp-intro").value,
                bank: document.getElementById("inp-bank").value,
                schedule: JSON.stringify(mySchedule)
            })
        });
        alert("成功！");
        btn.innerText = "儲存資料"; btn.disabled = false;
    }
</script>
</body>
</html>
