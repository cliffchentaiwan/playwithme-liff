<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªç©å“¡å·¥ä½œå°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #333; color: white; padding: 20px; text-align: center; padding-bottom: 60px; }
        .card { background: #444; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; color: #06c755; font-size: 20px; }
        p { color: #ccc; font-size: 14px; }
        .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        .btn:disabled { background-color: #666; cursor: not-allowed; }
        .btn-gps { background-color: #2196F3; color: white; }
        .btn-scan { background-color: #06c755; color: white; }
        
        .status-toggle { margin-bottom: 20px; padding: 20px; background: #222; border-radius: 15px; }
        .toggle-btn { padding: 10px 30px; border-radius: 30px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; }
        .offline { background-color: #555; color: #aaa; }
        .online { background-color: #06c755; color: white; box-shadow: 0 0 15px rgba(6, 199, 85, 0.5); }
        
        .status-box { background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; color: #aaa; text-align: left; min-height: 20px; word-break: break-all; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #06c755; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="profile">
        <div class="card">
            <p>æ­£åœ¨è®€å–èº«ä»½...</p>
        </div>
    </div>

    <div class="status-toggle">
        <h3>ğŸŸ¢ æ¥å–®ç‹€æ…‹</h3>
        <p id="status-text">ç›®å‰ç‹€æ…‹ï¼šé›¢ç·š (å®¶é•·çœ‹ä¸åˆ°ä½ )</p>
        <button id="btn-toggle" class="toggle-btn offline" onclick="toggleStatus()">ğŸ”´ é»æ­¤ä¸Šç·šæ¥å–®</button>
    </div>

    <div class="card">
        <h2>ğŸ“ æŠµé”æ‰“å¡</h2>
        <p>åˆ°é”æŒ‡å®šåœ°é»å¾Œï¼Œè«‹é»æ“Šå›å ±ã€‚</p>
        <button class="btn btn-gps" id="btn-gps" onclick="handleGPS()">å‚³é€ GPS ä½ç½®</button>
        <div class="status-box" id="gps-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="card">
        <h2>ğŸ“¸ å®Œå·¥æƒç¢¼</h2>
        <p>è«‹æƒæå®¶é•·æ‰‹æ©Ÿä¸Šçš„ QR Code ä»¥çµæ¡ˆã€‚</p>
        <button class="btn btn-scan" id="btn-scan" onclick="handleScan()">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
        <div class="status-box" id="scan-status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        // ğŸ‘‡ å·²ç¶“å¹«æ‚¨æ›ä¸Šæœ€æ–°çš„ç¶²å€äº†
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";

        let userProfile = null;
        let isOnline = false;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                
                document.getElementById("profile").innerHTML = `
                    <div class="card">
                        <img src="${userProfile.pictureUrl}" class="profile-img">
                        <h3>${userProfile.displayName}</h3>
                        <p>æ­¡è¿å›ä¾†å·¥ä½œ</p>
                    </div>
                `;
                
                if (!liff.isInClient()) {
                    document.getElementById("btn-scan").disabled = true;
                    document.getElementById("scan-status").innerText = "âš ï¸ æƒç¢¼åŠŸèƒ½éœ€åœ¨ LINE App å…§ä½¿ç”¨";
                }
            } catch (err) {
                alert("åˆå§‹åŒ–éŒ¯èª¤ï¼š" + err);
            }
        }

        function toggleStatus() {
            isOnline = !isOnline;
            const btn = document.getElementById("btn-toggle");
            const txt = document.getElementById("status-text");

            if (isOnline) {
                btn.className = "toggle-btn online";
                btn.innerText = "ğŸŸ¢ æ­£åœ¨ç·šä¸Š (é»æ­¤ä¸‹ç·š)";
                txt.innerText = "ç›®å‰ç‹€æ…‹ï¼šç·šä¸Š (å®¶é•·å¯ä»¥é ç´„)";
                updateServer("Online");
            } else {
                btn.className = "toggle-btn offline";
                btn.innerText = "ğŸ”´ é»æ­¤ä¸Šç·šæ¥å–®";
                txt.innerText = "ç›®å‰ç‹€æ…‹ï¼šé›¢ç·š (å®¶é•·çœ‹ä¸åˆ°ä½ )";
                updateServer("Offline");
            }
        }

        function updateServer(status) {
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "toggleStatus",
                    userId: userProfile.userId,
                    status: status
                })
            });
        }

        function handleGPS() {
            const statusBox = document.getElementById("gps-status");
            const btn = document.getElementById("btn-gps");
            if (!navigator.geolocation) {
                statusBox.innerText = "æ­¤è£ç½®ä¸æ”¯æ´ GPS"; return;
            }
            btn.disabled = true; btn.innerText = "å®šä½ä¸­...";
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const loc = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                statusBox.innerText = `âœ… å®šä½æˆåŠŸï¼š${loc}`;
                sendAction("checkin", loc);
                btn.innerText = "å·²æ‰“å¡";
            }, (err) => {
                statusBox.innerText = "å®šä½å¤±æ•—"; btn.disabled = false;
            });
        }

        async function handleScan() {
            const statusBox = document.getElementById("scan-status");
            try {
                const result = await liff.scanCodeV2();
                if (result.value) {
                    statusBox.innerText = "âœ… æƒææˆåŠŸ";
                    sendAction("scan", "ä»£ç¢¼:" + result.value);
                    alert("æƒææˆåŠŸï¼");
                }
            } catch (err) {
                statusBox.innerText = "æƒæå–æ¶ˆ";
            }
        }

        function sendAction(actionType, detail) {
            const data = {
                action: actionType, 
                userName: userProfile.displayName,
                detail: detail
            };
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });
        }

        main();
    </script>
</body>
</html>
