<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ (å®¶é•·ç«¯)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 80px; }
        .app-header { background: white; padding: 15px; font-weight: bold; text-align: center; position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 18px; }
        .worker-card { background: white; padding: 15px; margin: 15px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .worker-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #eee; }
        .worker-info { flex: 1; }
        .btn-book { background: #06c755; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; padding: 25px; border-radius: 20px 20px 0 0; box-sizing: border-box; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        label { font-weight: bold; color: #555; display: block; margin-top: 5px; }
        .btn-pay { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size: 40px;">ğŸ”</div>
    <div style="margin-top: 10px; color: #666;">è¼‰å…¥ä¸­...</div>
</div>

<div class="app-header">ğŸ” æ‰¾é™ªç©å¤¥ä¼´</div>
<div id="worker-list"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-name" style="margin-top:0;">é ç´„</h3>
        <label>æ™‚æ®µ</label><select id="inp-time"></select>
        <label>æ™‚æ•¸</label><select id="inp-hour" onchange="calcPrice()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
        <label>ç¸½é‡‘é¡</label><div id="total-price" style="color:#06c755; font-weight:bold; font-size:20px; margin-bottom:15px;">$0</div>
        <button class="btn-pay" onclick="goPay()">LINE Pay ä»˜æ¬¾</button>
        <button onclick="document.getElementById('booking-modal').classList.remove('show')" style="width:100%; padding:15px; background:none; border:none; margin-top:5px; color:#999; font-size: 16px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // âš ï¸ å‹™å¿…ç¢ºèªé€™æ˜¯æ‚¨æœ€æ–°éƒ¨ç½²çš„ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    
    let userProfile, selectedWorker;

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            loadWorkers();
        } catch(e) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + e);
        }
    };

    async function loadWorkers() {
        try {
            // ä½¿ç”¨ text/plain é¿å… iOS CORS éŒ¯èª¤
            let res = await fetch(SCRIPT_URL + "?action=getWorkers", {
                method: "GET",
                headers: { "Content-Type": "text/plain" }
            });
            let workers = await res.json();
            
            let html = "";
            if (workers.length === 0) html = "<p style='text-align:center; padding:20px; color:#999;'>ç›®å‰æ²’æœ‰ä¸Šç·šçš„å¤¥ä¼´</p>";
            
            workers.forEach(w => {
                html += `
                    <div class="worker-card">
                        <img class="worker-img" src="${w.photo || 'https://via.placeholder.com/80'}">
                        <div class="worker-info">
                            <div style="font-weight:bold; font-size:16px;">${w.name}</div>
                            <div style="font-size:13px; color:#666; margin: 4px 0;">${w.tags || 'ç„¡æ¨™ç±¤'}</div>
                            <div style="color:#06c755; font-weight:bold;">$${w.rate}/hr</div>
                        </div>
                        <button class="btn-book" onclick='openModal(${JSON.stringify(w)})'>é ç´„</button>
                    </div>`;
            });
            document.getElementById("worker-list").innerHTML = html;
            document.getElementById("loading").style.display = "none";
        } catch(e) {
            alert("è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
            document.getElementById("loading").style.display = "none";
        }
    }

    function openModal(w) {
        selectedWorker = w;
        document.getElementById("modal-name").innerText = "é ç´„ " + w.name;
        document.getElementById("booking-modal").classList.add("show");
        let sel = document.getElementById("inp-time");
        sel.innerHTML = "";
        try { 
            let sch = JSON.parse(w.schedule);
            if(sch.length > 0) sch.forEach(s => sel.innerHTML += `<option>${s}</option>`);
            else sel.innerHTML = "<option>ç„¡å¯é ç´„æ™‚æ®µ</option>";
        } catch(e) { sel.innerHTML = "<option>ç„¡å¯é ç´„æ™‚æ®µ</option>"; }
        calcPrice();
    }

    function calcPrice() {
        let h = document.getElementById("inp-hour").value;
        document.getElementById("total-price").innerText = "$" + (selectedWorker.rate * h);
    }

    async function goPay() {
        let btn = document.querySelector(".btn-pay");
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        try {
            let res = await fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" }, // é—œéµä¿®æ­£
                body: JSON.stringify({
                    action: "initPayment",
                    price: document.getElementById("total-price").innerText.replace("$",""),
                    productImageUrl: selectedWorker.photo
                })
            });
            let json = await res.json();
            if(json.success) window.location.href = json.paymentUrl;
            else { alert("å»ºç«‹è¨‚å–®å¤±æ•—"); btn.disabled = false; btn.innerText = "LINE Pay ä»˜æ¬¾"; }
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤: " + e);
            btn.disabled = false; btn.innerText = "LINE Pay ä»˜æ¬¾";
        }
    }
</script>
</body>
</html>
