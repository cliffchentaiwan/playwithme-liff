<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ (å®¶é•·ç«¯)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 80px; }
        .app-header { background: white; padding: 15px; font-weight: bold; text-align: center; position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .worker-card { background: white; padding: 15px; margin: 15px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .worker-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .worker-info { flex: 1; }
        .btn-book { background: #06c755; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; padding: 20px; border-radius: 20px 20px 0 0; box-sizing: border-box; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-pay { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body>

<div id="loading">è®€å–ä¸­...</div>
<div class="app-header">ğŸ” æ‰¾é™ªç©å¤¥ä¼´</div>
<div id="worker-list"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-name">é ç´„</h3>
        <label>æ™‚æ®µ</label><select id="inp-time"></select>
        <label>æ™‚æ•¸</label><select id="inp-hour" onchange="calcPrice()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
        <label>ç¸½é‡‘é¡</label><div id="total-price" style="color:#06c755; font-weight:bold; font-size:18px; margin-bottom:10px;">$0</div>
        <button class="btn-pay" onclick="goPay()">LINE Pay ä»˜æ¬¾</button>
        <button onclick="document.getElementById('booking-modal').classList.remove('show')" style="width:100%; padding:10px; background:none; border:none; margin-top:5px; color:#666;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // âš ï¸ è«‹ç¢ºèªé€™æ˜¯å‰›å‰› GAS éƒ¨ç½²å‡ºä¾†çš„ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    
    let userProfile, selectedWorker;

    window.onload = async function() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        loadWorkers();
    };

    async function loadWorkers() {
        // é€™æ˜¯æœ€åŸå§‹çš„ GET è«‹æ±‚ï¼Œé€šå¸¸æœ€ç©©å®š
        let res = await fetch(SCRIPT_URL + "?action=getWorkers");
        let workers = await res.json();
        
        let html = "";
        workers.forEach(w => {
            html += `
                <div class="worker-card">
                    <img class="worker-img" src="${w.photo || 'https://via.placeholder.com/80'}">
                    <div class="worker-info">
                        <div style="font-weight:bold;">${w.name}</div>
                        <div style="font-size:12px; color:#666;">${w.tags}</div>
                        <div style="color:#06c755; font-weight:bold;">$${w.rate}/hr</div>
                    </div>
                    <button class="btn-book" onclick='openModal(${JSON.stringify(w)})'>é ç´„</button>
                </div>`;
        });
        document.getElementById("worker-list").innerHTML = html;
        document.getElementById("loading").style.display = "none";
    }

    function openModal(w) {
        selectedWorker = w;
        document.getElementById("modal-name").innerText = "é ç´„ " + w.name;
        document.getElementById("booking-modal").classList.add("show");
        let sel = document.getElementById("inp-time");
        sel.innerHTML = "";
        try { JSON.parse(w.schedule).forEach(s => sel.innerHTML += `<option>${s}</option>`); } catch(e) { sel.innerHTML = "<option>ç„¡æ™‚æ®µ</option>"; }
        calcPrice();
    }

    function calcPrice() {
        let h = document.getElementById("inp-hour").value;
        document.getElementById("total-price").innerText = "$" + (selectedWorker.rate * h);
    }

    async function goPay() {
        let btn = document.querySelector(".btn-pay");
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        let res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "initPayment",
                price: document.getElementById("total-price").innerText.replace("$",""),
                productImageUrl: selectedWorker.photo
            })
        });
        let json = await res.json();
        if(json.success) window.location.href = json.paymentUrl;
        else { alert("å¤±æ•—"); btn.disabled = false; }
    }
</script>
</body>
</html>
