<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* === æ¢å¾©åŸæœ¬æ¼‚äº®çš„æ¨£å¼ === */
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; margin: 0; padding-bottom: 80px; color: #333; }
        .app-header { background: white; padding: 15px 20px; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .filter-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 10px 15px; scrollbar-width: none; }
        .filter-tag { background: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #666; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
        .filter-tag.active { background: #06C755; color: white; border-color: #06c755; }

        .worker-list { padding: 15px; }
        .worker-card { background: white; border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }
        .worker-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #eee; }
        .worker-info { flex: 1; overflow: hidden; }
        .worker-name { font-size: 17px; font-weight: bold; margin-bottom: 4px; }
        .worker-tags { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .worker-price { font-size: 16px; font-weight: bold; color: #06C755; margin-top: 5px; }
        .btn-book { background-color: #06C755; color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap; }

        /* å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: end; z-index: 2000; backdrop-filter: blur(2px); }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 24px 24px 0 0; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        label { display: block; font-size: 14px; font-weight: bold; color: #555; margin: 15px 0 8px 0; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        .btn-submit { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size:40px;">ğŸ”</div>
    <div style="color:#666; margin-top:10px;">ç³»çµ±é€£ç·šä¸­...</div>
</div>

<div class="app-header">ğŸ” æ‰¾é™ªç©å¤¥ä¼´</div>

<div class="filter-scroll">
    <div class="filter-tag active" onclick="filterWorkers('all', this)">å…¨éƒ¨</div>
    <div class="filter-tag" onclick="filterWorkers('ç•«ç•«', this)">ğŸ¨ ç•«ç•«</div>
    <div class="filter-tag" onclick="filterWorkers('é‹å‹•', this)">âš½ é‹å‹•</div>
    <div class="filter-tag" onclick="filterWorkers('éŸ³æ¨‚', this)">ğŸµ éŸ³æ¨‚</div>
    <div class="filter-tag" onclick="filterWorkers('é™ªç©', this)">ğŸ§¸ é™ªç©</div>
</div>

<div id="worker-list" class="worker-list"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="modal-worker-name" style="margin:0;">é ç´„</h3>
            <span onclick="closeModal()" style="font-size:24px; cursor:pointer; color:#999;">&times;</span>
        </div>
        
        <label>é ç´„æ™‚æ®µ</label>
        <select id="inp-time"><option>è¼‰å…¥ä¸­...</option></select>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>æ™‚æ•¸</label>
                <select id="inp-duration" onchange="updatePrice()">
                    <option value="1">1 å°æ™‚</option><option value="2">2 å°æ™‚</option><option value="3">3 å°æ™‚</option>
                </select>
            </div>
            <div style="flex:1;">
                <label>ç¸½é‡‘é¡</label>
                <div id="total-price" style="font-size:18px; font-weight:bold; color:#06c755; padding-top:10px;">$0</div>
            </div>
        </div>

        <label>å­©ç«¥è³‡è¨Š</label>
        <input type="text" id="inp-child" placeholder="ä¾‹å¦‚ï¼š5æ­² å°ç”·ç”Ÿ">

        <label>å‚™è¨»éœ€æ±‚</label>
        <textarea id="inp-note" rows="2" placeholder="æœ‰ä»€éº¼ç‰¹åˆ¥éœ€è¦æ³¨æ„çš„å—ï¼Ÿ"></textarea>

        <button class="btn-submit" onclick="initPayment()">å‰å¾€ LINE Pay ä»˜æ¬¾</button>
    </div>
</div>

<script>
    // æ‚¨çš„æ­£ç¢º GAS ç¶²å€ (V5.0 Restore)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    const LIFF_ID = "2008808827-DzeTt84n"; 

    let userProfile = null;
    let allWorkers = [];
    let selectedWorker = null;

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            loadWorkers();
        } catch (err) {
            alert("è¼‰å…¥å¤±æ•—: " + err);
            document.getElementById("loading").style.display = "none";
        }
    };

    async function loadWorkers() {
        try {
            // ä½¿ç”¨ fetchï¼Œçµ•å°ä¸è·³è½‰
            const res = await fetch(SCRIPT_URL + "?action=getWorkers");
            allWorkers = await res.json();
            renderWorkers(allWorkers);
            document.getElementById("loading").style.display = "none";
        } catch(e) {
            console.error(e);
            alert("ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œå°æ˜¯å¦æ­£å¸¸");
            document.getElementById("loading").style.display = "none";
        }
    }

    function renderWorkers(workers) {
        const list = document.getElementById("worker-list");
        list.innerHTML = "";
        if(workers.length === 0) { list.innerHTML = "<p style='text-align:center;padding:20px;'>ç›®å‰æ²’æœ‰ç¬¦åˆçš„å¤¥ä¼´</p>"; return; }
        
        workers.forEach(w => {
            const photo = (w.photo && w.photo.startsWith("http")) ? w.photo : "https://via.placeholder.com/70";
            const div = document.createElement("div");
            div.className = "worker-card";
            div.innerHTML = `
                <img class="worker-img" src="${photo}">
                <div class="worker-info">
                    <div class="worker-name">${w.name}</div>
                    <div class="worker-tags">${w.tags || "ç„¡æ¨™ç±¤"}</div>
                    <div class="worker-price">$${w.rate} / hr</div>
                </div>
                <button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>
            `;
            list.appendChild(div);
        });
    }

    function filterWorkers(tag, btn) {
        document.querySelectorAll(".filter-tag").forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        if(tag === 'all') renderWorkers(allWorkers);
        else renderWorkers(allWorkers.filter(w => (w.tags || "").includes(tag)));
    }

    function openBooking(worker) {
        selectedWorker = worker;
        document.getElementById("modal-worker-name").innerText = "é ç´„ " + worker.name;
        document.getElementById("booking-modal").classList.add("show");
        
        const sel = document.getElementById("inp-time");
        sel.innerHTML = "";
        let schedule = [];
        try { schedule = JSON.parse(worker.schedule); } catch(e){}
        
        if(!schedule || schedule.length === 0) {
            sel.innerHTML = "<option>ç„¡å¯é ç´„æ™‚æ®µ</option>";
        } else {
            schedule.forEach(slot => sel.innerHTML += `<option value="${slot}">${slot}</option>`);
        }
        updatePrice();
    }

    function updatePrice() {
        if(!selectedWorker) return;
        const h = parseFloat(document.getElementById("inp-duration").value);
        document.getElementById("total-price").innerText = "$" + (selectedWorker.rate * h);
    }

    function closeModal() { document.getElementById("booking-modal").classList.remove("show"); }

    async function initPayment() {
        const btn = document.querySelector(".btn-submit");
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

        const payload = {
            action: "initPayment",
            userName: userProfile.displayName,
            companion: selectedWorker.name,
            price: document.getElementById("total-price").innerText.replace("$", ""),
            bookingTime: document.getElementById("inp-time").value + " (" + document.getElementById("inp-duration").value + "hr)",
            childInfo: document.getElementById("inp-child").value,
            note: document.getElementById("inp-note").value,
            productImageUrl: selectedWorker.photo
        };

        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if(result.success) {
                window.location.href = result.paymentUrl; // åªæœ‰é€™è£¡æœƒè·³è½‰
            } else {
                alert("éŒ¯èª¤ï¼š" + result.message);
                btn.innerText="å‰å¾€ LINE Pay ä»˜æ¬¾"; btn.disabled=false;
            }
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤ï¼š" + e);
            btn.innerText="å‰å¾€ LINE Pay ä»˜æ¬¾"; btn.disabled=false;
        }
    }
</script>
</body>
</html>
