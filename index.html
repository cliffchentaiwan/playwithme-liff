<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; margin: 0; padding-bottom: 80px; color: #333; }
        .app-header { background: white; padding: 15px 20px; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .view-container { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .filter-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .filter-tag { background: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #666; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
        .filter-tag.active { background: #06C755; color: white; border-color: #06c755; }

        .worker-card { background: white; border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }
        .worker-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #eee; }
        .worker-info { flex: 1; overflow: hidden; }
        .worker-name { font-size: 17px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; }
        .worker-tags { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .worker-price { font-size: 16px; font-weight: bold; color: #06C755; }
        .btn-book { background-color: #06C755; color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap; }

        /* æ¨¡æ…‹æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: end; z-index: 2000; backdrop-filter: blur(2px); }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 24px 24px 0 0; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        label { display: block; font-size: 14px; font-weight: bold; color: #555; margin: 15px 0 8px 0; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        .btn-submit { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }

        /* è¨‚å–®èˆ‡åº•éƒ¨ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #aaa; font-size: 10px; width: 50%; cursor: pointer; }
        .nav-item.active { color: #06C755; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .order-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card.Paid { border-left-color: #f1c40f; }
        .order-card.Confirmed { border-left-color: #06C755; }
        
        #full-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #06C755; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="full-loading">
    <div class="loader"></div>
    <div style="color:#666; font-size:14px;">ç³»çµ±é€£ç·šä¸­...</div>
</div>

<div class="app-header">
    <span id="page-title">ğŸ” æ‰¾é™ªç©</span>
</div>

<div id="home-view" class="view-container active">
    <div class="filter-scroll">
        <div class="filter-tag active" onclick="filterWorkers('all', this)">å…¨éƒ¨</div>
        <div class="filter-tag" onclick="filterWorkers('ç•«ç•«', this)">ğŸ¨ ç•«ç•«</div>
        <div class="filter-tag" onclick="filterWorkers('é‹å‹•', this)">âš½ é‹å‹•</div>
        <div class="filter-tag" onclick="filterWorkers('éŸ³æ¨‚', this)">ğŸµ éŸ³æ¨‚</div>
        <div class="filter-tag" onclick="filterWorkers('é™ªç©', this)">ğŸ§¸ é™ªç©</div>
    </div>
    <div id="worker-list"></div>
</div>

<div id="orders-view" class="view-container">
    <div id="order-list">
        <div style="text-align:center; padding:50px; color:#999;">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="modal-worker-name" style="margin:0;">é ç´„</h3>
            <span onclick="closeModal()" style="font-size:24px; cursor:pointer; color:#999;">&times;</span>
        </div>
        <p style="color:#888; font-size:13px;">è«‹é¸æ“‡æ™‚æ®µä¸¦å¡«å¯«éœ€æ±‚</p>
        
        <label>é ç´„æ—¥æœŸ</label>
        <select id="inp-time"><option>è¼‰å…¥æ™‚æ®µä¸­...</option></select>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>æ™‚æ•¸</label>
                <select id="inp-duration">
                    <option value="1">1 å°æ™‚</option>
                    <option value="1.5">1.5 å°æ™‚</option>
                    <option value="2">2 å°æ™‚</option>
                    <option value="3">3 å°æ™‚</option>
                </select>
            </div>
            <div style="flex:1;">
                <label>ä»˜æ¬¾é‡‘é¡</label>
                <div id="total-price" style="font-size:18px; font-weight:bold; color:#06c755; padding-top:10px;">$0</div>
            </div>
        </div>

        <label>å­©ç«¥è³‡è¨Š</label>
        <input type="text" id="inp-child" placeholder="ä¾‹å¦‚ï¼š5æ­² å°ç”·ç”Ÿ">

        <label>å‚™è¨»éœ€æ±‚</label>
        <textarea id="inp-note" rows="2" placeholder="æœ‰ä»€éº¼ç‰¹åˆ¥éœ€è¦æ³¨æ„çš„å—ï¼Ÿ"></textarea>

        <button class="btn-submit" onclick="initPayment()">å‰å¾€ LINE Pay ä»˜æ¬¾</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
        <div class="nav-icon">ğŸ </div><div>é¦–é </div>
    </div>
    <div class="nav-item" id="nav-orders" onclick="switchTab('orders')">
        <div class="nav-icon">ğŸ“</div><div>è¨‚å–®</div>
    </div>
</div>

<script>
    // ğŸ”¥ è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„æœ€æ–° Exec ç¶²å€ï¼
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    const LIFF_ID = "2008808827-DzeTt84n"; 

    let userProfile = null;
    let allWorkers = [];
    let selectedWorker = null;

    // 1. åˆå§‹åŒ–
    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            userProfile = await liff.getProfile();
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè¨‚å–®é å›èª¿
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('page') === 'orders') {
                switchTab('orders');
            } else {
                loadWorkers();
            }
            document.getElementById("full-loading").style.display = "none";
        } catch (err) {
            alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š" + err);
        }
        
        document.getElementById("inp-duration").addEventListener("change", updatePrice);
    };

    // 2. è®€å–é™ªç©å“¡
    async function loadWorkers() {
        const list = document.getElementById("worker-list");
        list.innerHTML = '<p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p>';
        try {
            const res = await fetch(SCRIPT_URL + "?action=getWorkers");
            allWorkers = await res.json();
            renderWorkers(allWorkers);
        } catch(e) {
            list.innerHTML = '<p style="text-align:center;color:red;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</p>';
        }
    }

    function renderWorkers(workers) {
        const list = document.getElementById("worker-list");
        list.innerHTML = "";
        if(workers.length === 0) { list.innerHTML = "<p>ç›®å‰æ²’æœ‰ç¬¦åˆçš„å¤¥ä¼´</p>"; return; }
        
        workers.forEach(w => {
            // é˜²å‘†ï¼šç…§ç‰‡å£æ‰é¡¯ç¤ºé è¨­åœ–
            const photo = (w.photo && w.photo.startsWith("http")) ? w.photo : "https://via.placeholder.com/70?text=User";
            const div = document.createElement("div");
            div.className = "worker-card";
            div.innerHTML = `
                <img class="worker-img" src="${photo}">
                <div class="worker-info">
                    <div class="worker-name">${w.name}</div>
                    <div class="worker-tags">${w.tags || "ç„¡æ¨™ç±¤"}</div>
                    <div class="worker-price">$${w.rate} / hr</div>
                </div>
                <button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>
            `;
            list.appendChild(div);
        });
    }

    function filterWorkers(tag, btn) {
        document.querySelectorAll(".filter-tag").forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        if(tag === 'all') renderWorkers(allWorkers);
        else renderWorkers(allWorkers.filter(w => (w.tags || "").includes(tag)));
    }

    // 3. é ç´„é‚è¼¯
    function openBooking(worker) {
        selectedWorker = worker;
        document.getElementById("modal-worker-name").innerText = "é ç´„ " + worker.name;
        document.getElementById("booking-modal").classList.add("show");
        
        // è§£ææ™‚æ®µ
        const sel = document.getElementById("inp-time");
        sel.innerHTML = "";
        let schedule = [];
        try { schedule = JSON.parse(worker.schedule); } catch(e){}
        
        if(schedule.length === 0) {
            sel.innerHTML = "<option>ç„¡å¯é ç´„æ™‚æ®µ</option>";
            document.querySelector(".btn-submit").disabled = true;
        } else {
            // ç°¡å–®ç”Ÿæˆæœªä¾†æ—¥æœŸçš„é¸é … (é€™è£¡åªåšç°¡å–®ç¤ºç¯„ï¼Œå¯¦éš›å¯ç”¨æ›´è¤‡é›œçš„æ—¥æœŸåº«)
            schedule.forEach(slot => {
               sel.innerHTML += `<option value="${slot}">${slot}</option>`;
            });
            document.querySelector(".btn-submit").disabled = false;
        }
        updatePrice();
    }

    function updatePrice() {
        if(!selectedWorker) return;
        const h = parseFloat(document.getElementById("inp-duration").value);
        const total = Math.round(selectedWorker.rate * h);
        document.getElementById("total-price").innerText = "$" + total;
    }

    function closeModal() { document.getElementById("booking-modal").classList.remove("show"); }

    async function initPayment() {
        const btn = document.querySelector(".btn-submit");
        const originalText = btn.innerText;
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

        const bookingTime = document.getElementById("inp-time").value + " (" + document.getElementById("inp-duration").value + "h)";
        const child = document.getElementById("inp-child").value;
        const note = document.getElementById("inp-note").value;
        const price = document.getElementById("total-price").innerText.replace("$", "");

        if(!child) { alert("è«‹å¡«å¯«å­©ç«¥è³‡è¨Š"); btn.innerText=originalText; btn.disabled=false; return; }

        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "initPayment",
                    userName: userProfile.displayName,
                    companion: selectedWorker.name,
                    price: price,
                    bookingTime: bookingTime,
                    childInfo: child,
                    note: note,
                    productImageUrl: selectedWorker.photo // å‚³é€åœ–ç‰‡çµ¦ LINE Pay
                })
            });
            const result = await res.json();
            if(result.success) {
                window.location.href = result.paymentUrl;
            } else {
                alert("éŒ¯èª¤ï¼š" + result.message);
                btn.innerText=originalText; btn.disabled=false;
            }
        } catch(e) {
            alert("ç¶²è·¯éŒ¯èª¤ï¼š" + e);
            btn.innerText=originalText; btn.disabled=false;
        }
    }

    // 4. è¨‚å–®èˆ‡åˆ†é 
    function switchTab(tab) {
        document.querySelectorAll(".view-container").forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
        
        if(tab === 'home') {
            document.getElementById("home-view").classList.add("active");
            document.getElementById("nav-home").classList.add("active");
            document.getElementById("page-title").innerText = "ğŸ” æ‰¾é™ªç©";
        } else {
            document.getElementById("orders-view").classList.add("active");
            document.getElementById("nav-orders").classList.add("active");
            document.getElementById("page-title").innerText = "ğŸ“‹ æˆ‘çš„è¨‚å–®";
            loadMyOrders();
        }
    }

    async function loadMyOrders() {
        const list = document.getElementById("order-list");
        list.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
        
        const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getMyOrders", userName: userProfile.displayName, role: "parent" })
        });
        const data = await res.json();
        
        if(!data.orders || data.orders.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">å°šç„¡è¨‚å–®</p>';
            return;
        }

        let html = "";
        data.orders.forEach(o => {
            let statusText = "å¾…ç¢ºèª";
            let statusClass = "Paid";
            if(o.status === "Paid") statusText = "å·²ä»˜æ¬¾ (ç­‰å¾…æ¥å–®)";
            else if(o.status === "å·²æ¥å–®") { statusText = "âœ… å¤¥ä¼´å·²æ¥å–®"; statusClass = "Confirmed"; }
            else if(o.status === "Refunded") statusText = "âŒ å·²å–æ¶ˆé€€æ¬¾";
            
            html += `
                <div class="order-card ${statusClass}">
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-weight:bold;">
                        <span>${o.worker}</span>
                        <span style="font-size:12px;color:#666;background:#eee;padding:2px 6px;border-radius:4px;">${statusText}</span>
                    </div>
                    <div style="font-size:14px;color:#555;">
                        <div>ğŸ“… ${o.bookingTime}</div>
                        <div>ğŸ’° $${o.price}</div>
                        <div style="font-size:12px;color:#999;margin-top:5px;">å‚™è¨»ï¼š${o.note}</div>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }
</script>
</body>
</html>
