<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ä¿æŒåŸæœ¬æ¼‚äº®çš„ V2.5 CSS */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; color: #333; }
        h2 { color: #333; margin-bottom: 15px; font-size: 22px; font-weight: 800; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-tag { background: white; padding: 8px 16px; border-radius: 20px; border: 1px solid #eee; color: #666; font-size: 14px; white-space: nowrap; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .filter-tag.active { background: #06c755; color: white; border-color: #06c755; font-weight: bold; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); }
        .worker-list { display: grid; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; align-items: center; transition: transform 0.1s; border: 1px solid #f0f0f0; }
        .card:active { transform: scale(0.98); background: #fafafa; }
        .avatar { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info { flex: 1; overflow: hidden; }
        .name { font-size: 17px; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; color: #333; }
        .rating { font-size: 12px; color: #f57c00; margin-left: 6px; background: #fff3e0; padding: 2px 6px; border-radius: 6px; display: flex; align-items: center; }
        .tags { font-size: 13px; color: #888; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .price { font-size: 16px; color: #06c755; font-weight: 800; }
        .btn-book { background-color: #06c755; color: white; border: none; padding: 8px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.2); transition: background 0.2s; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: end; z-index: 2000; backdrop-filter: blur(2px); }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 24px 24px 0 0; animation: slideUp 0.3s cubic-bezier(0.25, 1, 0.5, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        label { display: block; font-size: 14px; font-weight: bold; color: #555; margin: 15px 0 8px 0; }
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; outline: none; transition: border 0.2s; }
        .row { display: flex; gap: 12px; }
        .col { flex: 1; }
        .price-summary { background: #e8f5e9; padding: 15px; border-radius: 12px; margin: 20px 0; display: flex; justify-content: space-between; align-items: center; border: 1px solid #c8e6c9; }
        .price-label { color: #2e7d32; font-size: 14px; font-weight: bold; }
        .total-price { font-size: 24px; font-weight: 900; color: #06c755; }
        .btn-submit { width: 100%; padding: 16px; background: #06c755; color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3); }
        .btn-submit:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        .close-btn { float: right; font-size: 24px; cursor: pointer; color: #ddd; margin-top: -10px; margin-right: -5px; padding: 5px; }

        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; color: transparent !important; border-radius: 6px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-text { height: 16px; margin-bottom: 6px; width: 60%; background: #eee; }
        .skeleton-avatar { width: 75px; height: 75px; background: #eee; border-radius: 50%; }
        
        /* æ”¯ä»˜ç¢ºèªé®ç½© */
        #payment-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #payment-overlay.hidden { display: none; }
    </style>
</head>
<body>

    <div id="payment-overlay" class="hidden">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ’³</div>
        <h3 style="margin:0;">æ­£åœ¨ç¢ºèªä»˜æ¬¾...</h3>
        <p style="color:#666;">è«‹å‹¿é—œé–‰è¦–çª—</p>
    </div>

    <h2 style="margin-left:5px;">ğŸ” å°‹æ‰¾é™ªç©å¤¥ä¼´</h2>

    <div class="filter-bar">
        <div class="filter-tag active" onclick="filterWorkers('all', this)">å…¨éƒ¨</div>
        <div class="filter-tag" onclick="filterWorkers('ç•«ç•«', this)">ğŸ¨ ç•«ç•«</div>
        <div class="filter-tag" onclick="filterWorkers('é‹¼ç´', this)">ğŸ¹ é‹¼ç´</div>
        <div class="filter-tag" onclick="filterWorkers('é‹å‹•', this)">âš½ é‹å‹•</div>
        <div class="filter-tag" onclick="filterWorkers('è‹±æ–‡', this)">ğŸ”¤ è‹±æ–‡</div>
        <div class="filter-tag" onclick="filterWorkers('é™ªç©', this)">ğŸ§¸ é™ªç©</div>
    </div>

    <div id="worker-list" class="worker-list"></div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">Ã—</span>
            <h3 id="modal-worker-name" style="margin-top:0; font-size: 20px;">é ç´„</h3>
            <p style="color:#888; font-size:14px; margin-bottom:20px;">ç¢ºèªå¾Œå°‡è·³è½‰è‡³ LINE Pay ä»˜æ¬¾ã€‚</p>
            
            <div class="row">
                <div class="col" style="flex:2">
                    <label>é ç´„æ—¥æœŸ (æœªä¾†å…©é€±)</label>
                    <select id="inp-time"><option>è¼‰å…¥ä¸­...</option></select>
                </div>
                <div class="col" style="flex:1">
                    <label>æ™‚æ•¸</label>
                    <select id="inp-duration">
                        <option value="1">1h</option><option value="1.5">1.5h</option><option value="2">2h</option>
                        <option value="2.5">2.5h</option><option value="3">3h</option><option value="4">4h</option>
                    </select>
                </div>
            </div>
            
            <label>å­©ç«¥è³‡è¨Š</label>
            <input type="text" id="inp-child" placeholder="ä¾‹å¦‚ï¼š5æ­² å°ç”·ç”Ÿ">
            
            <label>å‚™è¨»éœ€æ±‚</label>
            <textarea id="inp-note" rows="3" placeholder="ä¾‹å¦‚ï¼šéœ€è¦å¹«å¿™çœ‹åŠŸèª²"></textarea>

            <div class="price-summary">
                <span class="price-label">ä»˜æ¬¾é‡‘é¡</span>
                <span id="total-price" class="total-price">$0</span>
            </div>

            <button class="btn-submit" onclick="initPayment()">å‰å¾€ LINE Pay ä»˜æ¬¾</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec"; 
        
        let allWorkers = [];
        let userProfile = null;
        let selectedWorker = null;

        function renderSkeleton() { /* ...åŒå‰... */ 
             const list = document.getElementById("worker-list");
            let html = "";
            for(let i=0; i<4; i++) {
                html += `<div class="card"><div class="skeleton-avatar skeleton"></div><div class="info"><div class="name skeleton skeleton-text" style="width:40%"></div><div class="tags skeleton skeleton-text"></div><div class="price skeleton skeleton-text" style="width:30%"></div></div></div>`;
            }
            list.innerHTML = html;
        }

        async function main() {
            // ğŸ”¥ 1. æª¢æŸ¥æ˜¯å¦ç‚ºä»˜æ¬¾å›èª¿
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('transactionId');

            if (transactionId) {
                // å¦‚æœæœ‰ transactionIdï¼Œä»£è¡¨å‰›å¾ LINE Pay å›ä¾†
                document.getElementById("payment-overlay").classList.remove("hidden");
                await confirmPayment(transactionId);
                return; // åœæ­¢åŸ·è¡Œå¾ŒçºŒï¼Œå°ˆæ³¨è™•ç†ä»˜æ¬¾
            }

            // æ­£å¸¸è¼‰å…¥æµç¨‹
            renderSkeleton();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) { userProfile = await liff.getProfile(); } 
                else { liff.login(); return; }
                loadWorkers();
            } catch (err) { alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err); }
            
            document.getElementById("inp-duration").addEventListener("change", updatePrice);
        }

        async function loadWorkers() { /* ...åŒå‰... */ 
            try {
                const res = await fetch(SCRIPT_URL + "?action=getWorkers");
                const workers = await res.json();
                allWorkers = workers;
                renderWorkers(workers);
            } catch (err) { document.getElementById("worker-list").innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ğŸ˜¢ æš«æ™‚ç„¡æ³•è®€å–åˆ—è¡¨ï¼Œè«‹é‡æ–°æ•´ç†</p>`; }
        }

        function renderWorkers(workers) { /* ...åŒå‰... */ 
            const list = document.getElementById("worker-list");
            list.innerHTML = "";
            if (workers.length === 0) { list.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å¤¥ä¼´</p>`; return; }
            workers.forEach(w => {
                let ratingHtml = ""; let displayName = w.name; let displayTags = w.tags || "";
                if(displayTags.includes("â­")) { const match = displayTags.match(/â­(\d+\.\d+)/); if(match) { ratingHtml = `<span class="rating">â­ ${match[1]}</span>`; displayTags = displayTags.replace(/â­\d+\.\d+/, "").trim(); } }
                const photoUrl = w.photo && w.photo.startsWith("http") ? w.photo : "https://via.placeholder.com/70?text=No+Image";
                const div = document.createElement("div"); div.className = "card";
                div.innerHTML = `<img class="avatar" src="${photoUrl}"><div class="info"><div class="name">${displayName} ${ratingHtml}</div><div class="tags">${displayTags}</div><div class="price">$${w.rate} <span style="font-size:12px;color:#999;font-weight:normal;">/ å°æ™‚</span></div></div><button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>`;
                list.appendChild(div);
            });
        }
        function filterWorkers(tag, btn) { document.querySelectorAll(".filter-tag").forEach(el => el.classList.remove("active")); btn.classList.add("active"); if (tag === 'all') renderWorkers(allWorkers); else renderWorkers(allWorkers.filter(w => (w.tags || "").includes(tag))); }
        function generateDateOptions(schedule) { /* ...åŒå‰... */ 
             const dayMap = { "é€±æ—¥": 0, "é€±ä¸€": 1, "é€±äºŒ": 2, "é€±ä¸‰": 3, "é€±å››": 4, "é€±äº”": 5, "é€±å…­": 6 };
            const today = new Date(); let options = [];
            schedule.forEach(slot => {
                const parts = slot.split(" "); if (parts.length < 2) return;
                const dayStr = parts[0]; const timeStr = parts[1];
                if (!dayMap.hasOwnProperty(dayStr)) return;
                const targetDayIndex = dayMap[dayStr];
                for (let i = 0; i < 14; i++) {
                    const futureDate = new Date(); futureDate.setDate(today.getDate() + i);
                    if (futureDate.getDay() === targetDayIndex) {
                        const month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
                        const date = futureDate.getDate().toString().padStart(2, '0');
                        const dayShort = dayStr.replace("é€±", ""); 
                        const displayDate = `${month}/${date} (${dayShort}) ${timeStr}`;
                        const fullDate = `${futureDate.getFullYear()}/${month}/${date} (${dayShort}) ${timeStr}`;
                        const sortKey = futureDate.getTime() + parseInt(timeStr.replace(":", ""));
                        options.push({ val: fullDate, display: displayDate, sort: sortKey });
                    }
                }
            });
            options.sort((a, b) => a.sort - b.sort);
            return options;
        }

        function openBooking(worker) { /* ...åŒå‰... */ 
            selectedWorker = worker; document.getElementById("modal-worker-name").innerText = "é ç´„ " + worker.name; document.getElementById("booking-modal").classList.add("show");
            const sel = document.getElementById("inp-time"); sel.innerHTML = "<option>è¨ˆç®—æ™‚æ®µä¸­...</option>";
            let schedule = []; try { schedule = JSON.parse(worker.schedule); } catch(e) {}
            if (!schedule || schedule.length === 0) { sel.innerHTML = "<option>æ­¤å¤¥ä¼´æš«ç„¡å¯é ç´„æ™‚æ®µ</option>"; document.querySelector(".btn-submit").disabled = true; } else {
                const dateOptions = generateDateOptions(schedule);
                if (dateOptions.length === 0) { sel.innerHTML = "<option>è¿‘æœŸç„¡ç¬¦åˆæ™‚æ®µ</option>"; document.querySelector(".btn-submit").disabled = true; } else {
                    sel.innerHTML = ""; dateOptions.forEach(opt => { sel.innerHTML += `<option value="${opt.val}">${opt.display}</option>`; }); document.querySelector(".btn-submit").disabled = false;
                }
            }
            updatePrice();
        }
        function updatePrice() { if(!selectedWorker) return; const hours = parseFloat(document.getElementById("inp-duration").value); const total = Math.round(selectedWorker.rate * hours); document.getElementById("total-price").innerText = "$" + total; }
        function closeModal() { document.getElementById("booking-modal").classList.remove("show"); }

        // ğŸ”¥ 1. ç™¼èµ·ä»˜æ¬¾ (initPayment)
        async function initPayment() {
            const btn = document.querySelector(".btn-submit");
            const originalText = btn.innerText;
            btn.innerText = "ğŸ”„ é€£ç·š LINE Pay..."; btn.disabled = true;

            const timeRaw = document.getElementById("inp-time").value;
            const duration = document.getElementById("inp-duration").value;
            const child = document.getElementById("inp-child").value;
            const note = document.getElementById("inp-note").value;
            const totalPrice = document.getElementById("total-price").innerText.replace("$", "");
            
            if (!child) { alert("è«‹å¡«å¯«å­©ç«¥è³‡è¨Š"); btn.innerText=originalText; btn.disabled=false; return; }
            
            const fullBookingInfo = `${timeRaw} (${duration}å°æ™‚)`;

            const data = {
                action: "initPayment", // å‘¼å«å¾Œç«¯ç™¼èµ·ä»˜æ¬¾
                userName: userProfile.displayName,
                companion: selectedWorker.name,
                price: totalPrice,
                bookingTime: fullBookingInfo,
                childInfo: child,
                note: note,
                productName: "é™ªç©æœå‹™: " + selectedWorker.name,
                productImageUrl: selectedWorker.photo || ""
            };

            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
                const result = await res.json();
                
                if (result.success) {
                    // ğŸ”¥ æ‹¿åˆ°ä»˜æ¬¾é€£çµï¼Œè·³è½‰å‡ºå»ï¼
                    window.location.href = result.paymentUrl;
                } else {
                    alert("LINE Pay ç™¼ç”ŸéŒ¯èª¤: " + result.message);
                    btn.innerText = originalText; btn.disabled = false;
                }
            } catch (err) { 
                alert("é€£ç·šå¤±æ•—ï¼š" + err); 
                btn.innerText = originalText; btn.disabled = false;
            } 
        }

        // ğŸ”¥ 2. ç¢ºèªä»˜æ¬¾ (confirmPayment)
        async function confirmPayment(transactionId) {
            try {
                const res = await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ 
                        action: "confirmPayment", 
                        transactionId: transactionId 
                    }) 
                });
                const result = await res.json();
                
                if (result.success) {
                    alert("âœ… ä»˜æ¬¾æˆåŠŸï¼\n\næ‚¨å·²å®Œæˆé ç´„ï¼Œè«‹ç­‰å¾…å¤¥ä¼´æ¥å–®ã€‚");
                    // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œå›åˆ°ä¹¾æ·¨çš„é¦–é 
                    window.history.replaceState({}, document.title, window.location.pathname);
                    document.getElementById("payment-overlay").classList.add("hidden");
                    renderSkeleton();
                    loadWorkers();
                } else {
                    alert("âŒ ä»˜æ¬¾ç¢ºèªå¤±æ•—ï¼š" + result.message);
                    document.getElementById("payment-overlay").classList.add("hidden");
                }
            } catch(e) {
                alert("ç³»çµ±éŒ¯èª¤ï¼š" + e);
                document.getElementById("payment-overlay").classList.add("hidden");
            }
        }

        main();
    </script>
</body>
</html>
