<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; padding-bottom: 80px; }
        .card { background: white; padding: 15px; border-radius: 16px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .avatar { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .name { font-size: 17px; font-weight: 800; margin-bottom: 4px; }
        .btn-book { background: #06c755; color: white; border: none; padding: 8px 20px; border-radius: 25px; font-weight: bold; margin-left: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; padding: 25px; border-radius: 24px 24px 0 0; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; height: 100px; margin-bottom: 10px; border-radius: 10px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #payment-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #payment-overlay.hidden { display: none; }
    </style>
</head>
<body>
    <div id="payment-overlay" class="hidden">ğŸ’³æ­£åœ¨ç¢ºèªä»˜æ¬¾ï¼Œè«‹ç¨å€™...</div>
    <h2 style="margin-left:5px;">ğŸ” å°‹æ‰¾é™ªç©å¤¥ä¼´</h2>
    <div id="worker-list"></div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-worker-name">é ç´„</h3>
            <label>é ç´„æ—¥æœŸ (æœªä¾†äºŒé€±)</label><select id="inp-time"></select>
            <label>æ™‚æ•¸</label><select id="inp-duration" onchange="updatePrice()"><option value="1">1h</option><option value="2">2h</option><option value="3">3h</option></select>
            <label>å­©ç«¥è³‡è¨Š</label><input type="text" id="inp-child" placeholder="ä¾‹å¦‚ï¼šä¸€ä½3æ­²å¥³å­©">
            <label>å‚™è¨»éœ€æ±‚</label><textarea id="inp-note" rows="2"></textarea>
            <div style="margin:20px 0; font-size: 18px; font-weight:bold;">ä»˜æ¬¾é‡‘é¡ï¼š<span id="total-price" style="color:#06c755;">$0</span></div>
            <button class="btn-book" style="width:100%; padding:15px; font-size:18px;" onclick="initPayment()">å‰å¾€ LINE Pay ä»˜æ¬¾</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; border:none; background:none; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n";
        const SCRIPT_URL = "åœ¨æ­¤å¡«å…¥æ‚¨çš„_GAS_URL";
        let allWorkers = [], userProfile = null, selectedWorker = null;

        async function main() {
            renderSkeleton();
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('transactionId')) { document.getElementById("payment-overlay").classList.remove("hidden"); return; }
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                loadWorkers();
            } catch (err) { console.error(err); }
        }

        function renderSkeleton() { document.getElementById("worker-list").innerHTML = '<div class="skeleton"></div><div class="skeleton"></div>'; }

        async function loadWorkers() {
            const res = await fetch(SCRIPT_URL + "?action=getWorkers");
            allWorkers = await res.json();
            document.getElementById("worker-list").innerHTML = allWorkers.map(w => `
                <div class="card">
                    <img class="avatar" src="${w.photo || 'https://via.placeholder.com/75'}">
                    <div class="info">
                        <div class="name">${w.name}</div>
                        <div style="color:#888; font-size:13px;">${w.tags || 'å°ˆæ¥­æœå‹™'}</div>
                        <div style="color:#06c755; font-weight:bold;">$${w.rate}/hr</div>
                    </div>
                    <button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>
                </div>
            `).join('');
        }

        function openBooking(worker) {
            selectedWorker = worker;
            document.getElementById("modal-worker-name").innerText = "é ç´„ " + worker.name;
            const schedule = JSON.parse(worker.schedule || "[]");
            // æ—¥æœŸç”¢ç”Ÿå™¨é‚è¼¯
            document.getElementById("inp-time").innerHTML = generateOptions(schedule).map(o => `<option value="${o}">${o}</option>`).join('') || '<option>æš«ç„¡æ™‚æ®µ</option>';
            document.getElementById("booking-modal").classList.add("show");
            updatePrice();
        }

        function generateOptions(schedule) {
            const dayMap = { "é€±æ—¥":0, "é€±ä¸€":1, "é€±äºŒ":2, "é€±ä¸‰":3, "é€±å››":4, "é€±äº”":5, "é€±å…­":6 };
            let opts = [];
            schedule.forEach(slot => {
                const parts = slot.split(" ");
                for(let i=0; i<14; i++) {
                    const d = new Date(); d.setDate(d.getDate()+i);
                    if(d.getDay() === dayMap[parts[0]]) opts.push(`${d.getMonth()+1}/${d.getDate()} (${parts[0].replace("é€±","")}) ${parts[1]}`);
                }
            });
            return opts.sort();
        }

        function updatePrice() { document.getElementById("total-price").innerText = "$" + (selectedWorker.rate * document.getElementById("inp-duration").value); }

        async function initPayment() {
            const payload = {
                action: "initPayment", userName: userProfile.displayName, companion: selectedWorker.name,
                price: document.getElementById("total-price").innerText.replace("$",""),
                bookingTime: document.getElementById("inp-time").value + " (" + document.getElementById("inp-duration").value + "h)",
                childInfo: document.getElementById("inp-child").value,
                productImageUrl: selectedWorker.photo
            };
            const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.success) window.location.href = result.paymentUrl;
        }

        function closeModal() { document.getElementById("booking-modal").classList.remove("show"); }
        main();
    </script>
</body>
</html>
