<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ (å®¶é•·ç«¯)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 80px; }
        .header { background: white; padding: 15px; font-weight: bold; font-size: 18px; text-align: center; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card { background: white; padding: 15px; margin: 15px; border-radius: 10px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #eee; }
        .info { flex: 1; }
        .price { color: #06c755; font-weight: bold; }
        .btn-book { background: #06c755; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; padding: 20px; border-radius: 20px 20px 0 0; box-sizing: border-box; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-pay { width: 100%; padding: 15px; background: #06c755; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:2000; }
    </style>
</head>
<body>

<div id="loading">ç³»çµ±è¼‰å…¥ä¸­...</div>
<div class="header">ğŸ” æ‰¾é™ªç©å¤¥ä¼´</div>

<div id="worker-list"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">é ç´„</h3>
        <label>é¸æ“‡æ™‚æ®µ</label>
        <select id="inp-time"></select>
        
        <label>æ™‚æ•¸ (å°æ™‚)</label>
        <select id="inp-duration" onchange="updatePrice()">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        </select>
        
        <label>å­©ç«¥è³‡è¨Š</label>
        <input type="text" id="inp-child" placeholder="ä¾‹å¦‚: 5æ­²å°å¯¶">
        
        <label>å‚™è¨»</label>
        <textarea id="inp-note"></textarea>
        
        <p style="text-align:right; font-weight:bold; font-size:18px; color:#06c755;" id="total-price">$0</p>
        
        <button class="btn-pay" onclick="goPay()">å‰å¾€ LINE Pay ä»˜æ¬¾</button>
        <button onclick="closeModal()" style="width:100%; padding:10px; background:transparent; border:none; color:#999; margin-top:10px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const LIFF_ID = "2008808827-DzeTt84n";
    // ç›´æ¥æ”¾å…¥æ‚¨ç¢ºèªéæ­£ç¢ºçš„ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    
    let userProfile = null;
    let selectedWorker = null;

    window.onload = async function() {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        loadWorkers();
    };

    async function loadWorkers() {
        try {
            // ç”¨ fetch æŠ“å–ï¼Œä¸æœƒè·³è½‰
            let res = await fetch(SCRIPT_URL + "?action=getWorkers");
            let data = await res.json();
            
            let html = "";
            data.forEach(w => {
                let photo = w.photo || "https://via.placeholder.com/60";
                html += `
                    <div class="card">
                        <img class="avatar" src="${photo}">
                        <div class="info">
                            <div style="font-weight:bold; font-size:16px;">${w.name}</div>
                            <div style="font-size:12px; color:#666; margin:5px 0;">${w.tags}</div>
                            <div class="price">$${w.rate} / hr</div>
                        </div>
                        <button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>
                    </div>
                `;
            });
            document.getElementById("worker-list").innerHTML = html;
            document.getElementById("loading").style.display = "none";
        } catch(e) {
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS éƒ¨ç½²ç‚ºæœ€æ–°ç‰ˆæœ¬");
            document.getElementById("loading").style.display = "none";
        }
    }

    function openBooking(worker) {
        selectedWorker = worker;
        document.getElementById("modal-title").innerText = "é ç´„ " + worker.name;
        document.getElementById("booking-modal").classList.add("show");
        
        // ç°¡å–®è§£ææ™‚æ®µ
        let sel = document.getElementById("inp-time");
        sel.innerHTML = "";
        let schedule = [];
        try { schedule = JSON.parse(worker.schedule); } catch(e){}
        if(schedule.length===0) sel.innerHTML = "<option>ç„¡å¯é ç´„æ™‚æ®µ</option>";
        else schedule.forEach(s => sel.innerHTML += `<option>${s}</option>`);
        
        updatePrice();
    }

    function updatePrice() {
        if(!selectedWorker) return;
        let h = document.getElementById("inp-duration").value;
        document.getElementById("total-price").innerText = "$" + (selectedWorker.rate * h);
    }

    function closeModal() {
        document.getElementById("booking-modal").classList.remove("show");
    }

    async function goPay() {
        let btn = document.querySelector(".btn-pay");
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        
        let payload = {
            action: "initPayment",
            userName: userProfile.displayName,
            companion: selectedWorker.name,
            price: document.getElementById("total-price").innerText.replace("$",""),
            bookingTime: document.getElementById("inp-time").value,
            childInfo: document.getElementById("inp-child").value,
            note: document.getElementById("inp-note").value,
            productImageUrl: selectedWorker.photo
        };

        try {
            let res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            let result = await res.json();
            if(result.success) {
                window.location.href = result.paymentUrl;
            } else {
                alert("éŒ¯èª¤: " + result.message);
                btn.innerText = "å‰å¾€ LINE Pay ä»˜æ¬¾"; btn.disabled = false;
            }
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤: " + e);
            btn.innerText = "å‰å¾€ LINE Pay ä»˜æ¬¾"; btn.disabled = false;
        }
    }
</script>
</body>
</html>
