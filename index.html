<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* === åŸºç¤æ¨£å¼ === */
    body { font-family: -apple-system, sans-serif; background-color: #f8f9fa; margin: 0; padding-bottom: 80px; color: #333; }
    
    /* é ‚éƒ¨ Header */
    .app-header { background: white; padding: 15px 20px; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .refresh-btn { font-size: 14px; color: #06C755; cursor: pointer; display: none; } /* è¨‚å–®é æ‰é¡¯ç¤º */

    /* é é¢åˆ‡æ› */
    .view-container { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
    .view-container.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* === é¦–é å…ƒä»¶ === */
    .filter-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; margin-bottom: 15px; scrollbar-width: none; }
    .filter-tag { background: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .filter-tag.active { background: #06C755; color: white; font-weight: bold; }

    .worker-card { background: white; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .worker-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; }
    .worker-info { flex: 1; }
    .worker-name { font-size: 18px; font-weight: bold; }
    .worker-price { font-size: 16px; font-weight: bold; color: #06C755; }
    .btn-book { background-color: #06C755; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

    /* === è¨‚å–®å…ƒä»¶ (æ ¸å¿ƒå„ªåŒ–) === */
    .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ddd; position: relative; }
    
    /* ç‹€æ…‹é¡è‰²å®šç¾© */
    .order-card.Paid { border-left-color: #f1c40f; }       /* é»ƒè‰²ï¼šå·²ä»˜æ¬¾ï¼Œå¾…ç¢ºèª */
    .order-card.Confirmed { border-left-color: #06C755; }  /* ç¶ è‰²ï¼šå·²ç¢ºèªï¼Œæº–å‚™æœå‹™ */
    .order-card.Refunded { border-left-color: #e74c3c; }   /* ç´…è‰²ï¼šå·²å–æ¶ˆé€€æ¬¾ */
    .order-card.Completed { border-left-color: #3498db; }  /* è—è‰²ï¼šå·²å®Œæˆ */

    .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; background: #eee; }
    
    /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
    .Paid .status-badge { background: #fef9e7; color: #f1c40f; }
    .Confirmed .status-badge { background: #e8f5e9; color: #06C755; }
    .Refunded .status-badge { background: #fdedec; color: #e74c3c; }

    .order-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; color: #555; }
    .label { color: #999; }

    /* å–æ¶ˆæŒ‰éˆ• */
    .btn-cancel {
      width: 100%; margin-top: 10px; padding: 10px;
      background: white; border: 1px solid #e74c3c; color: #e74c3c;
      border-radius: 8px; font-size: 14px; cursor: pointer;
    }
    .btn-cancel:active { background: #fdedec; }

    /* åº•éƒ¨å°èˆª */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #aaa; font-size: 10px; width: 50%; cursor: pointer; }
    .nav-item.active { color: #06C755; }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }

    /* Loading */
    #full-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #06C755; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="app-header">
    <span id="page-title">ğŸ” æ‰¾é™ªç©</span>
    <span class="refresh-btn" onclick="loadOrders()">ğŸ”„ æ›´æ–°</span>
  </div>

  <div id="home-view" class="view-container active">
    <div class="filter-scroll">
      <div class="filter-tag active">å…¨éƒ¨</div>
      <div class="filter-tag">ğŸ€ ç±ƒçƒ</div>
      <div class="filter-tag">ğŸ¨ ç•«ç•«</div>
    </div>

    <div class="worker-card">
      <img src="https://profile.line-scdn.net/0hdajbSSwiO05HGyQ-P5VFcDdLOCRkamJcYn52LHAZNi4qL3lKa3hyenUYYil8Kn9MbXp8L3odNndlVQxQOQp9LnpPbT0YQ3tONip8YSpBJysDWCdoDhUMc3QTAHYychxtbAYQQQdeERhyYBlPD13SyZoZgQBbjQZLUxXGEIpVc0oGUwbanx9IXMSbH38" class="worker-img">
      <div class="worker-info">
        <div class="worker-name">Cliffæ˜‡æµ©</div>
        <div style="font-size:12px;color:#888;">é™ªç©ç¶“é©—è±å¯Œï¼Œæ“…é•·å¸¶å‹•æ°£æ°›</div>
        <div class="worker-price">$500 <small>/hr</small></div>
      </div>
      <button class="btn-book" onclick="startBooking('Cliffæ˜‡æµ©', 500)">é ç´„</button>
    </div>
  </div>

  <div id="orders-view" class="view-container">
    <div id="order-list">
      <div style="text-align:center; padding:50px; color:#999;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
      <div class="nav-icon">ğŸ </div><div>é¦–é </div>
    </div>
    <div class="nav-item" id="nav-orders" onclick="switchTab('orders')">
      <div class="nav-icon">ğŸ“</div><div>è¨‚å–®</div>
    </div>
  </div>

  <div id="full-loading">
    <div class="loader"></div>
    <div style="margin-top:10px; color:#666;">è™•ç†ä¸­...</div>
  </div>

  <script>
    // âš ï¸ é€™è£¡å¡«å…¥æ‚¨ V7.0 çš„ GAS ç¶²å€
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec";
    const LIFF_ID = "2008808827-DzeTt84n";

    let userProfile = null;

    window.onload = function() {
      if (liff) {
        liff.init({ liffId: LIFF_ID }).then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              userProfile = profile;
              // æª¢æŸ¥æ˜¯å¦è¦ç›´æ¥è·³è½‰è¨‚å–®é 
              const urlParams = new URLSearchParams(window.location.search);
              if (urlParams.get('page') === 'orders') {
                switchTab('orders');
              }
            });
          }
        });
      }
    };

    function switchTab(tab) {
      document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      if (tab === 'home') {
        document.getElementById('home-view').classList.add('active');
        document.getElementById('nav-home').classList.add('active');
        document.getElementById('page-title').innerText = "ğŸ” æ‰¾é™ªç©";
        document.querySelector('.refresh-btn').style.display = 'none';
      } else {
        document.getElementById('orders-view').classList.add('active');
        document.getElementById('nav-orders').classList.add('active');
        document.getElementById('page-title').innerText = "ğŸ“‹ æˆ‘çš„è¨‚å–®";
        document.querySelector('.refresh-btn').style.display = 'block';
        loadOrders();
      }
    }

    function startBooking(worker, price) {
      if(!userProfile) return alert("è«‹ç¨å¾Œ...");
      if(!confirm(`ç¢ºå®šé ç´„ ${worker} ($${price})ï¼Ÿ`)) return;
      
      showLoading(true);
      
      const payload = {
        action: "initPayment",
        userName: userProfile.displayName,
        companion: worker,
        price: price,
        bookingTime: "2026-02-14 14:00", // ç¯„ä¾‹æ™‚é–“
        childInfo: "å°å¯¶ (6æ­²)",
        note: "ç„¡"
      };

      fetch(BACKEND_URL, { method: "POST", body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
    // é€™æ¨£æ‰èƒ½è®“ä½¿ç”¨è€…å‰å¾€ LINE Pay ä»˜æ¬¾é é¢
    window.location.href = data.paymentUrl;
}
        else { alert("éŒ¯èª¤: " + data.message); showLoading(false); }
      });
    }

    function loadOrders() {
      if(!userProfile) return;
      const list = document.getElementById('order-list');
      list.innerHTML = '<div style="text-align:center;padding:50px;color:#aaa;"><div class="loader"></div> æ›´æ–°ä¸­...</div>';

      fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getMyOrders", userName: userProfile.displayName })
      })
      .then(res => res.json())
      .then(data => {
        if(!data.orders || data.orders.length === 0) {
          list.innerHTML = '<div style="text-align:center;padding:50px;color:#aaa;">ğŸ“­ å°šç„¡è¨‚å–®</div>';
          return;
        }
        
        let html = '';
        data.orders.forEach(order => {
          // ç‹€æ…‹ç¿»è­¯èˆ‡é¡è‰²
          let statusText = "å¾…ç¢ºèª";
          let statusClass = "Paid";
          let canCancel = false;

          if (order.status === "Paid") { 
            statusText = "å¾…ç¢ºèª (ç­‰å¾…æ¥å–®)"; 
            statusClass = "Paid"; 
            canCancel = true; // åªæœ‰é€™å€‹ç‹€æ…‹å¯ä»¥å–æ¶ˆ
          }
          else if (order.status === "Confirmed") { statusText = "âœ… å·²ç¢ºèª"; statusClass = "Confirmed"; }
          else if (order.status === "Refunded") { statusText = "å·²å–æ¶ˆé€€æ¬¾"; statusClass = "Refunded"; }
          
          html += `
            <div class="order-card ${statusClass}">
              <div class="order-header">
                <span style="font-weight:bold">${order.worker}</span>
                <div class="status-badge">${statusText}</div>
              </div>
              <div class="order-row"><span class="label">æ™‚é–“</span> ${order.bookingTime}</div>
              <div class="order-row"><span class="label">å‚™è¨»</span> ${order.note}</div>
              <div class="order-row"><span class="label">é‡‘é¡</span> $${order.price}</div>
              
              ${canCancel ? `<button class="btn-cancel" onclick="cancelOrder('${order.transactionId}')">å–æ¶ˆé ç´„ä¸¦é€€æ¬¾</button>` : ''}
            </div>
          `;
        });
        list.innerHTML = html;
      });
    }

    function cancelOrder(tId) {
      if(!confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®ä¸¦é€€æ¬¾å—ï¼Ÿ")) return;
      showLoading(true);

      fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify({ 
          action: "cancelOrder", 
          transactionId: tId,
          userName: userProfile.displayName 
        })
      })
      .then(res => res.json())
      .then(data => {
        showLoading(false);
        alert(data.message);
        loadOrders(); // é‡æ–°æ•´ç†åˆ—è¡¨
      });
    }

    function showLoading(show) {
      document.getElementById('full-loading').style.display = show ? 'flex' : 'none';
    }
  </script>
</body>
</html>
