<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­©å‹å‹ - å°‹æ‰¾é™ªç©å¤¥ä¼´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; color: #333; }
        h2 { color: #333; margin-bottom: 20px; font-size: 24px; }
        
        /* æœå°‹èˆ‡ç¯©é¸å€ */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-tag { background: white; padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; color: #666; font-size: 14px; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .filter-tag.active { background: #06c755; color: white; border-color: #06c755; font-weight: bold; }

        .worker-list { display: grid; gap: 15px; }
        
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        
        .avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 1px solid #eee; }
        .info { flex: 1; }
        .name { font-size: 18px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; }
        .rating { font-size: 13px; color: #f57c00; margin-left: 8px; background: #fff3e0; padding: 2px 6px; border-radius: 4px; }
        .tags { font-size: 13px; color: #666; margin-bottom: 4px; }
        .price { font-size: 16px; color: #06c755; font-weight: bold; }
        
        .btn-book { background-color: #06c755; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-book:disabled { background-color: #ccc; cursor: not-allowed; }

        /* å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: end; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        .btn-submit { width: 100%; padding: 14px; background: #06c755; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-submit:disabled { background: #999; }
        .close-btn { float: right; font-size: 24px; cursor: pointer; color: #999; }

        /* âœ¨ éª¨æ¶å±å‹•ç•« (è®“è¼‰å…¥çœ‹èµ·ä¾†å¾ˆå¿«) */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; color: transparent !important; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .skeleton-text { height: 16px; margin-bottom: 5px; width: 60%; background: #eee; }
        .skeleton-avatar { width: 70px; height: 70px; background: #eee; border-radius: 50%; }
    </style>
</head>
<body>

    <h2 style="margin-left:5px;">ğŸ” å°‹æ‰¾é™ªç©å¤¥ä¼´</h2>

    <div class="filter-bar">
        <div class="filter-tag active" onclick="filterWorkers('all', this)">å…¨éƒ¨</div>
        <div class="filter-tag" onclick="filterWorkers('ç•«ç•«', this)">ğŸ¨ ç•«ç•«</div>
        <div class="filter-tag" onclick="filterWorkers('é‹¼ç´', this)">ğŸ¹ é‹¼ç´</div>
        <div class="filter-tag" onclick="filterWorkers('é‹å‹•', this)">âš½ é‹å‹•</div>
        <div class="filter-tag" onclick="filterWorkers('è‹±æ–‡', this)">ğŸ”¤ è‹±æ–‡</div>
    </div>

    <div id="worker-list" class="worker-list">
        </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">Ã—</span>
            <h3 id="modal-worker-name" style="margin-top:0">é ç´„</h3>
            <p style="color:#666; font-size:14px; margin-bottom:15px;">è«‹å¡«å¯«é ç´„è³‡è¨Šï¼Œå¤¥ä¼´ç¢ºèªå¾Œæœƒé€šçŸ¥æ‚¨ã€‚</p>
            
            <label>é¸æ“‡æ™‚æ®µ</label>
            <select id="inp-time">
                <option>è¼‰å…¥æ™‚æ®µä¸­...</option>
            </select>
            
            <label>å­©ç«¥è³‡è¨Š (å¹´é½¡/æ€§åˆ¥)</label>
            <input type="text" id="inp-child" placeholder="ä¾‹å¦‚ï¼š5æ­² ç”·ç”Ÿ">
            
            <label>å‚™è¨»éœ€æ±‚</label>
            <textarea id="inp-note" rows="3" placeholder="ä¾‹å¦‚ï¼šéœ€è¦å¹«å¿™çœ‹åŠŸèª²"></textarea>

            <button class="btn-submit" onclick="submitBooking()">é€å‡ºé ç´„</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008808827-DzeTt84n"; 
        // ğŸ‘‡ å‹™å¿…ç¢ºèªé€™æ˜¯æœ€æ–°çš„ Apps Script ç¶²å€
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBLO3480Hv5WZs_j7zjUZUvaflboGRyo0_TW94XpQnJo6Uhez7NA_xgSiGxrvDP4LJ/exec"; 
        
        let allWorkers = [];
        let userProfile = null;
        let selectedWorker = null;

        // åˆå§‹åŒ–ï¼šå…ˆé¡¯ç¤º 3 å€‹å‡å¡ç‰‡ (éª¨æ¶å±)
        function renderSkeleton() {
            const list = document.getElementById("worker-list");
            let html = "";
            for(let i=0; i<3; i++) {
                html += `
                <div class="card">
                    <div class="skeleton-avatar skeleton"></div>
                    <div class="info">
                        <div class="name skeleton skeleton-text" style="width:40%"></div>
                        <div class="tags skeleton skeleton-text"></div>
                        <div class="price skeleton skeleton-text" style="width:30%"></div>
                    </div>
                </div>`;
            }
            list.innerHTML = html;
        }

        async function main() {
            renderSkeleton(); // âœ¨ 1. é¦¬ä¸Šé¡¯ç¤ºéª¨æ¶å±
            
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                } else {
                    liff.login();
                    return;
                }
                loadWorkers(); // âœ¨ 2. èƒŒæ™¯è¼‰å…¥è³‡æ–™
            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err);
            }
        }

        async function loadWorkers() {
            try {
                // å‘¼å«å¾Œç«¯ API
                const res = await fetch(SCRIPT_URL + "?action=getWorkers"); // é€™è£¡ç”¨ GET
                const workers = await res.json();
                allWorkers = workers;
                renderWorkers(workers); // âœ¨ 3. è³‡æ–™å›ä¾†äº†ï¼Œæ›¿æ›æ‰éª¨æ¶å±
            } catch (err) {
                document.getElementById("worker-list").innerHTML = `<p style="text-align:center; color:#999;">ğŸ˜¢ æš«æ™‚ç„¡æ³•è®€å–åˆ—è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
            }
        }

        function renderWorkers(workers) {
            const list = document.getElementById("worker-list");
            list.innerHTML = "";
            
            if (workers.length === 0) {
                list.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰ä¸Šç·šçš„å¤¥ä¼´</p>`;
                return;
            }

            workers.forEach(w => {
                // è§£æè©•åˆ†
                let ratingHtml = "";
                let displayName = w.name;
                // å¾ tags è£¡æŠŠ â­ åˆ†æ•¸æŒ–å‡ºä¾†é¡¯ç¤ºåœ¨åå­—æ—é‚Šï¼Œä¸¦å¾ tag è£¡ç§»é™¤ï¼Œä¿æŒä¹¾æ·¨
                let displayTags = w.tags;
                if(w.tags && w.tags.includes("â­")) {
                    const match = w.tags.match(/â­(\d+\.\d+)/);
                    if(match) {
                        ratingHtml = `<span class="rating">â­ ${match[1]}</span>`;
                        // ç§»é™¤ tag å­—ä¸²è£¡çš„æ˜Ÿæ˜Ÿï¼Œé¿å…é‡è¤‡é¡¯ç¤º
                        displayTags = displayTags.replace(/â­\d+\.\d+/, "").trim(); 
                    }
                }

                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `
                    <img class="avatar" src="${w.photo}" onerror="this.src='https://via.placeholder.com/70'">
                    <div class="info">
                        <div class="name">${displayName} ${ratingHtml}</div>
                        <div class="tags">${displayTags}</div>
                        <div class="price">$${w.rate} / å°æ™‚</div>
                    </div>
                    <button class="btn-book" onclick='openBooking(${JSON.stringify(w)})'>é ç´„</button>
                `;
                list.appendChild(div);
            });
        }

        function filterWorkers(tag, btn) {
            // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll(".filter-tag").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");

            if (tag === 'all') {
                renderWorkers(allWorkers);
            } else {
                const filtered = allWorkers.filter(w => w.tags.includes(tag));
                renderWorkers(filtered);
            }
        }

        function openBooking(worker) {
            selectedWorker = worker;
            document.getElementById("modal-worker-name").innerText = "é ç´„ " + worker.name;
            document.getElementById("booking-modal").classList.add("show");
            
            // è§£ææ™‚æ®µ
            const sel = document.getElementById("inp-time");
            sel.innerHTML = "";
            let schedule = [];
            try { schedule = JSON.parse(worker.schedule); } catch(e) {}
            
            if (schedule.length === 0) {
                sel.innerHTML = "<option>æ­¤å¤¥ä¼´æš«ç„¡å¯é ç´„æ™‚æ®µ</option>";
                document.querySelector(".btn-submit").disabled = true;
            } else {
                schedule.forEach(s => {
                    sel.innerHTML += `<option value="${s}">${s}</option>`;
                });
                document.querySelector(".btn-submit").disabled = false;
            }
        }

        function closeModal() {
            document.getElementById("booking-modal").classList.remove("show");
        }

        // ğŸš€ UXå„ªåŒ–ï¼šé ç´„æŒ‰éˆ•ç‹€æ…‹å›é¥‹
        async function submitBooking() {
            const btn = document.querySelector(".btn-submit");
            const originalText = btn.innerText;
            
            // 1. é–ä½æŒ‰éˆ•
            btn.innerText = "ğŸ”„ è™•ç†ä¸­...";
            btn.disabled = true;

            const time = document.getElementById("inp-time").value;
            const child = document.getElementById("inp-child").value;
            const note = document.getElementById("inp-note").value;

            if (!child) { alert("è«‹å¡«å¯«å­©ç«¥è³‡è¨Š"); btn.innerText=originalText; btn.disabled=false; return; }

            const data = {
                action: "book",
                userName: userProfile.displayName,
                companion: selectedWorker.name,
                price: selectedWorker.rate,
                bookingTime: time,
                childInfo: child,
                note: note
            };

            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
                alert("âœ… é ç´„æˆåŠŸï¼è«‹ç­‰å¾…å¤¥ä¼´ç¢ºèªã€‚");
                closeModal();
            } catch (err) {
                alert("âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            } finally {
                // 2. æ¢å¾©æŒ‰éˆ• (ä¸ç®¡æˆåŠŸå¤±æ•—)
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        main();
    </script>
</body>
</html>
